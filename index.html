<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>team group nbtel</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #0ea5e9;
  --accent-hover: #0284c7;
  --muted: #6b7280;
  --text: #111827;
  --green: #10b981;
  --yellow: #f59e0b;
  --red: #ef4444;
  --blue: #3b82f6;
  color-scheme: light;
}
body {
  font-family: 'Segoe UI', Tahoma, Arial, Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 12px;
}
.container {
  max-width: 1200px;
  margin: 12px auto;
  padding: 16px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
h1 {
  margin: 0 0 16px;
  font-size: clamp(20px, 5vw, 22px);
  text-align: center;
  color: var(--accent);
}
form {
  display: grid;
  gap: 12px;
}
label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 4px;
  display: block;
}
input[type=text], input[type=tel], textarea, select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  color: var(--text);
  font-size: 14px;
  transition: border 0.2s, box-shadow 0.2s;
  box-sizing: border-box;
}
input[type=text]:focus, input[type=tel]:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(14,165,233,0.2);
}
.row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
#map {
  height: 250px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.offers {
  background: #f3f4f6;
  padding: 10px;
  border-radius: 8px;
}
.offers label {
  display: block;
  padding: 6px 0;
  cursor: pointer;
  font-size: 14px;
}
.btn {
  display: inline-block;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  text-align: center;
  width: 100%;
  max-width: 200px;
}
.btn:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
}
.muted {
  font-size: 12px;
  color: var(--muted);
}
img.logo {
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
#manualOffer {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  width: 100%;
  display: none;
  margin-top: 8px;
  box-sizing: border-box;
}
#offerDetails {
  margin-top: 8px;
  padding: 8px;
  background: #eef2f7;
  border-radius: 8px;
  font-size: 13px;
}
#offersModal, #editOfferModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#offersModal > div, #editOfferModal > div {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  max-width: 90%;
  width: 400px;
  max-height: 80vh;
  overflow-y: auto;
}
.stats-section {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-bottom: 16px;
}
.stats-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--accent);
  text-align: center;
}
.stats-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.stat-card {
  background: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  border-right: 3px solid var(--accent);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.stat-card.today {
  border-right-color: #10b981;
}
.stat-card.offers {
  border-right-color: #f59e0b;
}
.stat-value {
  font-size: 20px;
  font-weight: 700;
  margin: 4px 0;
  color: var(--text);
}
.stat-label {
  font-size: 12px;
  color: var(--muted);
}
.popular-offers {
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin-top: 8px;
}
.offer-stat {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #f1f5f9;
  font-size: 13px;
}
.offer-stat:last-child {
  border-bottom: none;
}
.offer-name {
  font-weight: 500;
}
.offer-count {
  color: var(--accent);
  font-weight: 600;
}
.bookings-section {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-top: 16px;
}
.bookings-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--accent);
  text-align: center;
}
#bookingsTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
#bookingsTable th, #bookingsTable td {
  border: 1px solid #e5e7eb;
  padding: 8px;
  text-align: right;
  font-size: 13px;
}
#bookingsTable th {
  background: #f1f5f9;
  font-weight: 600;
}
#bookingsTable tr:nth-child(even) {
  background: #f9fafb;
}
#bookingsTable .edit-btn, #bookingsTable .delete-btn, #bookingsTable .map-btn {
  background: #f59e0b;
  padding: 6px 12px;
  border-radius: 4px;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 12px;
  width: auto;
}
#bookingsTable .delete-btn {
  background: #ef4444;
}
#bookingsTable .map-btn {
  background: #6366f1;
}
#bookingsTable .edit-btn:hover {
  background: #d97706;
}
#bookingsTable .delete-btn:hover {
  background: #dc2626;
}
#bookingsTable .map-btn:hover {
  background: #4f46e5;
}
.status-led {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-left: 8px;
  vertical-align: middle;
}
.status-led.green {
  background: var(--green);
}
.status-led.yellow {
  background: var(--yellow);
}
.status-led.red {
  background: var(--red);
}
.status-led.blue {
  background: var(--blue);
}
.offer-item {
  margin-bottom: 8px;
  padding: 8px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #f9fafb;
}
.offer-item input, .offer-item select {
  width: 100%;
  padding: 8px;
  margin-bottom: 4px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  box-sizing: border-box;
}
.removeOfferBtn {
  background: #f87171;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 4px;
  width: 100%;
}
.removeOfferBtn:hover {
  background: #ef4444;
}
@media (min-width: 768px) {
  .container {
    padding: 20px;
    margin: 20px auto;
  }
  h1 {
    font-size: 24px;
  }
  .row {
    grid-template-columns: 1fr 1fr;
  }
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .btn {
    max-width: 180px;
  }
  #map {
    height: 300px;
  }
  #bookingsTable th, #bookingsTable td {
    padding: 10px;
    font-size: 14px;
  }
}
@media (max-width: 767px) {
  body {
    padding: 8px;
  }
  .container {
    padding: 12px;
    margin: 8px;
    border-radius: 8px;
  }
  h1 {
    font-size: 18px;
  }
  form {
    gap: 10px;
  }
  label {
    font-size: 13px;
  }
  input[type=text], input[type=tel], textarea, select {
    padding: 8px;
    font-size: 13px;
  }
  .btn {
    padding: 8px 12px;
    font-size: 13px;
    max-width: 100%;
  }
  #map {
    height: 200px;
  }
  .stats-section, .bookings-section {
    padding: 10px;
  }
  .stats-title, .bookings-title {
    font-size: 15px;
  }
  .stat-card {
    padding: 8px;
  }
  .stat-value {
    font-size: 18px;
  }
  .stat-label {
    font-size: 11px;
  }
  .offer-stat {
    font-size: 12px;
  }
  #offersModal > div, #editOfferModal > div {
    width: 95%;
    padding: 12px;
  }
  #bookingsTable {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
}
</style>
</head>
<body>
<div class="container">
  <div style="text-align:center; margin-bottom:12px;">
    <img src="https://reseller.nbtel.iq/nb_logo.png" alt="شعار NBTEL" class="logo" style="width:100px; height:auto;">
  </div>
  <h1>حجوزات خدمات الإنترنت — تلكيف</h1>
  <div class="stats-section">
    <div class="stats-title">إحصائيات الحجوزات</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">إجمالي الحجوزات</div>
        <div class="stat-value" id="totalBookings">0</div>
      </div>
      <div class="stat-card today">
        <div class="stat-label">حجوزات اليوم</div>
        <div class="stat-value" id="todayBookings">0</div>
      </div>
      <div class="stat-card offers">
        <div class="stat-label">عدد العروض</div>
        <div class="stat-value" id="totalOffers">0</div>
      </div>
    </div>
    <div class="popular-offers">
      <div style="font-weight:600; margin-bottom:8px; color:var(--muted); font-size:13px;">العروض الأكثر شيوعاً:</div>
      <div id="popularOffers">لا توجد بيانات كافية</div>
    </div>
  </div>
  <form id="bookingForm" autocomplete="on" novalidate>
    <div class="row">
      <div>
        <label for="name">الاسم</label>
        <input id="name" name="name" type="text" placeholder="مثال: علي" required>
      </div>
      <div>
        <label for="phone">رقم الهاتف</label>
        <input id="phone" name="phone" type="tel" placeholder="أدخل رقم الهاتف" required>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="agent">اسم الوكيل</label>
        <input id="agent" name="agent" type="text" placeholder="أدخل اسم الوكيل">
      </div>
      <div>
        <label for="pppoeUsername">Username PPPoE</label>
        <input id="pppoeUsername" name="pppoeUsername" type="text" placeholder="أدخل Username PPPoE">
      </div>
    </div>
    <div>
      <label>نوع العرض</label>
      <div class="offers" id="offersContainer"></div>
      <input type="text" id="manualOffer" placeholder="اكتب العرض هنا..." style="display:none;">
      <div id="offerDetails">اختر عرضاً لرؤية التفاصيل هنا.</div>
      <button type="button" class="btn" style="background:#6366f1;margin-top:8px" id="manageOffersBtn">إدارة العروض</button>
    </div>
    <div>
      <label for="notes">ملاحظات إضافية</label>
      <textarea id="notes" name="notes" rows="3" placeholder="عنوان مفصل، طابق، ملاحظات عن الوصول..."></textarea>
    </div>
    <div>
      <label for="status">الحالة</label>
      <select id="status" name="status">
        <option value="تم الاشتراك">تم الاشتراك</option>
        <option value="غير موافق">غير موافق</option>
        <option value="غير مشترك">غير مشترك</option>
        <option value="تم رفض نهائي">تم رفض نهائي</option>
      </select>
    </div>
    <div>
      <label>تحديد موقعك على الخريطة أو استخدم مشاركة الموقع</label>
      <div id="map"></div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
        <button type="button" id="locateBtn" class="btn">مشاركة الموقع</button>
        <button type="button" id="pickBtn" class="btn">اختر نقطة</button>
        <button type="button" id="clearBtn" class="btn" style="background:#f87171">محو الإحداثيات</button>
      </div>
      <div class="muted" style="margin-top:8px">إحداثيات مختارة: <span id="coords">لم يتم التحديد</span></div>
    </div>
    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lng" name="lng">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;margin-top:8px;justify-content:end;">
      <button type="submit" class="btn">حفظ الحجز وإرسال الفردي</button>
      <button type="button" id="exportBtn" class="btn" style="background:#38bdf8">تصدير Excel</button>
      <button type="button" id="backupBtn" class="btn" style="background:#16a34a">نسخة احتياطية يومية</button>
      <input type="file" id="importJSON" style="display:none">
      <button type="button" class="btn" style="background:#f59e0b" id="importBtn">استيراد JSON</button>
      <button type="button" class="btn" style="background:#f87171" id="clearAllBtn">محو كل الحجوزات</button>
      <button type="button" class="btn" style="background:#ef4444" id="clearTodayBtn">حذف حجوزات اليوم</button>
      <button type="button" class="btn" style="background:#6b7280" id="toggleTableBtn">إخفاء القائمة</button>
    </div>
  </form>
  <div class="bookings-section" id="bookingsSection">
    <div class="bookings-title">قائمة الحجوزات</div>
    <div style="margin-bottom:12px;">
      <label for="searchByName">البحث عن حجز بالاسم</label>
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
        <input type="text" id="searchByName" placeholder="أدخل اسم العميل" />
        <button type="button" class="btn" style="background:#6366f1" id="searchByNameBtn">بحث</button>
      </div>
    </div>
    <table id="bookingsTable">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>رقم الهاتف</th>
          <th>اسم الوكيل</th>
          <th>Username PPPoE</th>
          <th>العرض</th>
          <th>ملاحظات</th>
          <th>الحالة</th>
          <th>الإحداثيات</th>
          <th>فتح الخريطة</th>
          <th>تعديل</th>
          <th>حذف</th>
        </tr>
      </thead>
      <tbody id="bookingsTableBody"></tbody>
    </table>
  </div>
</div>
<div id="offersModal">
  <div>
    <h2 style="margin-top:0">إدارة العروض</h2>
    <div id="offersList"></div>
    <button type="button" class="btn" id="addOfferBtn" style="background:#10b981;margin-top:8px">إضافة عرض جديد</button>
    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
      <button type="button" class="btn" id="saveOffersBtn">حفظ التعديلات</button>
      <button type="button" class="btn" style="background:#f87171" id="closeOffersBtn">إغلاق</button>
    </div>
  </div>
</div>
<div id="editOfferModal">
  <div>
    <h2 style="margin-top:0">تعديل الحجز</h2>
    <div class="row">
      <div>
        <label for="editAgent">اسم الوكيل</label>
        <input id="editAgent" name="editAgent" type="text" placeholder="أدخل اسم الوكيل">
      </div>
      <div>
        <label for="editPppoeUsername">Username PPPoE</label>
        <input id="editPppoeUsername" name="editPppoeUsername" type="text" placeholder="أدخل Username PPPoE">
      </div>
    </div>
    <div class="offers" id="editOffersContainer"></div>
    <input type="text" id="editManualOffer" placeholder="اكتب العرض يدوياً..." style="display:none;">
    <div>
      <label for="editNotes">ملاحظات إضافية</label>
      <textarea id="editNotes" name="editNotes" rows="3" placeholder="عنوان مفصل، طابق، ملاحظات عن الوصول..."></textarea>
    </div>
    <div>
      <label for="editStatus">الحالة</label>
      <select id="editStatus" name="editStatus">
        <option value="تم الاشتراك">تم الاشتراك</option>
        <option value="غير موافق">غير موافق</option>
        <option value="غير مشترك">غير مشترك</option>
        <option value="تم رفض نهائي">تم رفض نهائي</option>
      </select>
    </div>
    <div>
      <label>الإحداثيات</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <input type="text" id="editLat" placeholder="خط العرض" />
        <input type="text" id="editLng" placeholder="خط الطول" />
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
        <button type="button" class="btn" id="editLocateBtn">مشاركة الموقع</button>
        <button type="button" class="btn" id="editPickBtn">اختر نقطة</button>
        <button type="button" class="btn" style="background:#f87171" id="editClearBtn">محو الإحداثيات</button>
      </div>
      <div id="editMap" style="height:200px;margin-top:8px;border-radius:8px;border:1px solid #e5e7eb;"></div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
      <button type="button" class="btn" id="saveEditOfferBtn">حفظ التعديل</button>
      <button type="button" class="btn" style="background:#f87171" id="closeEditOfferBtn">إغلاق</button>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======= نظام الإحصائيات =======
let bookings = JSON.parse(localStorage.getItem('bookings')) || [];
let offerInfo = JSON.parse(localStorage.getItem('offerInfo')) || {
    "عرض الألياف البصرية": {description: "اشتراك إنترنت بسرعة 100 ميغابت/ث مع تركيب مجاني", price: "100,000 د.ع"},
    "عرض العائلة": {description: "اشتراك لمدة 6 أشهر بسرعة 50 ميغابت/ث", price: "60,000 د.ع"},
    "عرض الطلاب": {description: "اشتراك إنترنت بسرعة 25 ميغابت/ث للطلاب", price: "40,000 د.ع"}
};
function updateStats() {
    try {
        console.log('تحديث الإحصائيات: عدد الحجوزات =', bookings.length);
        document.getElementById('totalBookings').textContent = bookings.length;
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(booking => {
            if (!booking.التاريخ) return false;
            const bookingDate = new Date(booking.التاريخ).toISOString().split('T')[0];
            return bookingDate === today;
        }).length;
        document.getElementById('todayBookings').textContent = todayBookings;
        const uniqueOffers = new Set(bookings.map(booking => booking.العرض).filter(offer => offer));
        const totalOffers = Object.keys(offerInfo).length + (uniqueOffers.size - Object.keys(offerInfo).filter(offer => uniqueOffers.has(offer)).length);
        document.getElementById('totalOffers').textContent = totalOffers;
        updatePopularOffers();
        renderBookingsTable();
    } catch (error) {
        console.error('خطأ في تحديث الإحصائيات:', error);
    }
}
function updatePopularOffers() {
    try {
        if (bookings.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:12px;">لا توجد حجوزات بعد</div>';
            return;
        }
        const offerCounts = {};
        bookings.forEach(booking => {
            const offer = booking.العرض || 'غير محدد';
            offerCounts[offer] = (offerCounts[offer] || 0) + 1;
        });
        const sortedOffers = Object.entries(offerCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        if (sortedOffers.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:12px;">لا توجد بيانات كافية</div>';
            return;
        }
        let html = '';
        sortedOffers.forEach(([offer, count]) => {
            html += `<div class="offer-stat"><span class="offer-name">${offer}</span><span class="offer-count">${count} حجز</span></div>`;
        });
        document.getElementById('popularOffers').innerHTML = html;
    } catch (error) {
        console.error('خطأ في تحديث العروض الشائعة:', error);
    }
}

// ======= الجدول =======
let currentSearchQuery = '';
function renderBookingsTable(searchQuery = '') {
    try {
        console.log('عرض الجدول: عدد الحجوزات =', bookings.length, 'استعلام البحث:', searchQuery);
        const tbody = document.getElementById('bookingsTableBody');
        if (!tbody) {
            console.error('عنصر bookingsTableBody غير موجود');
            return;
        }
        let html = '';
        const filteredBookings = searchQuery ? 
            bookings.filter(booking => booking.الاسم.toLowerCase().includes(searchQuery.toLowerCase())) : 
            bookings;
        if (filteredBookings.length === 0) {
            html = `<tr><td colspan="11" style="text-align:center;color:var(--muted);">
                ${searchQuery ? 'لا توجد حجوزات مطابقة لـ "' + searchQuery + '"' : 'لا توجد حجوزات'}
                </td></tr>`;
        } else {
            filteredBookings.forEach((booking, index) => {
                if (!booking || !booking.الاسم || !booking.الهاتف || !booking.العرض) {
                    console.warn('حجز غير صالح في الفهرس:', index, booking);
                    return;
                }
                const originalIndex = bookings.indexOf(booking);
                const statusClass = {
                    'تم الاشتراك': 'green',
                    'غير موافق': 'yellow',
                    'غير مشترك': 'red',
                    'تم رفض نهائي': 'blue'
                }[booking.الحالة] || 'red';
                const coords = booking.الإحداثيات || 'غير محدد';
                const mapButton = coords !== 'غير محدد' ? 
                    `<button class="map-btn" data-index="${originalIndex}" data-coords="${coords}">فتح الخريطة</button>` : 
                    'غير متاح';
                html += `
                    <tr>
                        <td>${booking.الاسم || 'غير محدد'}</td>
                        <td>${booking.الهاتف || 'غير محدد'}</td>
                        <td>${booking.اسم_الوكيل || 'غير محدد'}</td>
                        <td>${booking.اسم_المستخدم || 'غير محدد'}</td>
                        <td>${booking.العرض || 'غير محدد'}</td>
                        <td>${booking.ملاحظات || 'لا توجد ملاحظات'}</td>
                        <td><span class="status-led ${statusClass}"></span> ${booking.الحالة || 'غير مشترك'}</td>
                        <td>${coords}</td>
                        <td>${mapButton}</td>
                        <td><button class="edit-btn" data-index="${originalIndex}">تعديل</button></td>
                        <td><button class="delete-btn" data-index="${originalIndex}">حذف</button></td>
                    </tr>`;
            });
        }
        tbody.innerHTML = html;
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = btn.getAttribute('data-index');
                openEditOfferModal(index);
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = btn.getAttribute('data-index');
                const booking = bookings[index];
                if (confirm(`هل أنت متأكد من حذف حجز ${booking.الاسم}؟`)) {
                    bookings.splice(index, 1);
                    saveBookings();
                    alert('تم حذف الحجز بنجاح!');
                    renderBookingsTable(currentSearchQuery);
                }
            });
        });
        document.querySelectorAll('.map-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const coords = btn.getAttribute('data-coords').split(',');
                const lng = parseFloat(coords[1].trim()); // الأول أصبح خط الطول
                const lat = parseFloat(coords[0].trim()); // الثاني أصبح خط العرض
                if (!isNaN(lat) && !isNaN(lng)) {
                    window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
                } else {
                    alert('الإحداثيات غير صالحة');
                }
            });
        });
    } catch (error) {
        console.error('خطأ في عرض جدول الحجوزات:', error);
        alert('حدث خطأ أثناء عرض جدول الحجوزات.');
    }
}

// ======= البحث عن الحجوزات =======
document.getElementById('searchByNameBtn').addEventListener('click', () => {
    try {
        const searchQuery = document.getElementById('searchByName').value.trim();
        currentSearchQuery = searchQuery;
        renderBookingsTable(searchQuery);
    } catch (error) {
        console.error('خطأ في البحث عن الحجوزات:', error);
        alert('حدث خطأ أثناء البحث.');
    }
});
document.getElementById('searchByName').addEventListener('input', () => {
    try {
        const searchQuery = document.getElementById('searchByName').value.trim();
        currentSearchQuery = searchQuery;
        renderBookingsTable(searchQuery);
    } catch (error) {
        console.error('خطأ في تحديث البحث:', error);
    }
});

// ======= إظهار/إخفاء الجدول =======
const toggleTableBtn = document.getElementById('toggleTableBtn');
const bookingsSection = document.getElementById('bookingsSection');
toggleTableBtn.addEventListener('click', () => {
    try {
        if (bookingsSection.style.display === 'none') {
            bookingsSection.style.display = 'block';
            toggleTableBtn.textContent = 'إخفاء القائمة';
            renderBookingsTable(currentSearchQuery);
        } else {
            bookingsSection.style.display = 'none';
            toggleTableBtn.textContent = 'إظهار القائمة';
        }
    } catch (error) {
        console.error('خطأ في إظهار/إخفاء الجدول:', error);
    }
});

// ======= حذف حجوزات اليوم =======
document.getElementById('clearTodayBtn').addEventListener('click', () => {
    try {
        if (confirm('هل أنت متأكد من حذف جميع حجوزات اليوم؟')) {
            const today = new Date().toISOString().split('T')[0];
            bookings = bookings.filter(booking => {
                if (!booking.التاريخ) return true;
                const bookingDate = new Date(booking.التاريخ).toISOString().split('T')[0];
                return bookingDate !== today;
            });
            localStorage.setItem('bookings', JSON.stringify(bookings));
            updateStats();
            renderBookingsTable(currentSearchQuery);
            alert('تم حذف حجوزات اليوم بنجاح!');
        }
    } catch (error) {
        console.error('خطأ في حذف حجوزات اليوم:', error);
        alert('حدث خطأ أثناء حذف حجوزات اليوم.');
    }
});

// ======= تعديل الحجز =======
let currentEditIndex = null;
let editMap, editMarker;
function openEditOfferModal(index) {
    try {
        currentEditIndex = index;
        const editOffersContainer = document.getElementById('editOffersContainer');
        editOffersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'editOffer';
            radio.value = key;
            radio.id = 'edit-offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            editOffersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'editOffer';
        manualRadio.value = 'manual';
        manualRadio.id = 'edit-offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'edit-offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' كتابة العرض يدوياً'));
        editOffersContainer.appendChild(manualLabel);
        const editManualOfferInput = document.getElementById('editManualOffer');
        const editNotesInput = document.getElementById('editNotes');
        const editStatusSelect = document.getElementById('editStatus');
        const editLatInput = document.getElementById('editLat');
        const editLngInput = document.getElementById('editLng');
        const editAgentInput = document.getElementById('editAgent');
        const editPppoeUsernameInput = document.getElementById('editPppoeUsername');
        editManualOfferInput.style.display = 'none';
        editManualOfferInput.value = '';
        editNotesInput.value = bookings[index].ملاحظات || '';
        editStatusSelect.value = bookings[index].الحالة || 'غير مشترك';
        editAgentInput.value = bookings[index].اسم_الوكيل || '';
        editPppoeUsernameInput.value = bookings[index].اسم_المستخدم || '';
        const currentOffer = bookings[index].العرض || '';
        const isManual = !offerInfo[currentOffer];
        if (isManual) {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
            editManualOfferInput.value = currentOffer;
        } else if (hasOffers) {
            const offerRadio = document.querySelector(`input[name="editOffer"][value="${currentOffer}"]`);
            if (offerRadio) offerRadio.checked = true;
            else document.getElementById('edit-offer-manual').checked = true;
        } else {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
        }
        // تحميل الإحداثيات
        const coords = bookings[index].الإحداثيات?.split(',') || [];
        editLatInput.value = coords[0]?.trim() || '';
        editLngInput.value = coords[1]?.trim() || '';
        // إعداد الخريطة
        if (!editMap) {
            editMap = L.map('editMap', { zoomControl: true }).setView([36.3719, 43.1228], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(editMap);
        } else {
            editMap.setView([36.3719, 43.1228], 12);
        }
        if (editMarker) {
            editMap.removeLayer(editMarker);
            editMarker = null;
        }
        if (editLatInput.value && editLngInput.value) {
            const lat = parseFloat(editLatInput.value);
            const lng = parseFloat(editLngInput.value);
            if (!isNaN(lat) && !isNaN(lng)) {
                editMarker = L.marker([lat, lng]).addTo(editMap);
                editMap.flyTo([lat, lng], 16);
            }
        }
        document.getElementById('editOfferModal').style.display = 'flex';
    } catch (error) {
        console.error('خطأ في فتح نافذة تعديل الحجز:', error);
        alert('حدث خطأ أثناء فتح نافذة التعديل.');
    }
}
document.getElementById('saveEditOfferBtn').addEventListener('click', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (!selectedRadio) {
            alert('يرجى اختيار عرض أو كتابة عرض يدوي.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? document.getElementById('editManualOffer').value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('يرجى كتابة تفاصيل العرض اليدوي.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' — السعر: ' + offerInfo[selectedOffer].price : selectedOffer);
        const lat = document.getElementById('editLat').value.trim();
        const lng = document.getElementById('editLng').value.trim();
        const coords = lat && lng ? `${lat}, ${lng}` : 'غير محدد';
        bookings[currentEditIndex].العرض = offerText;
        bookings[currentEditIndex].التفاصيل = offerDesc;
        bookings[currentEditIndex].ملاحظات = document.getElementById('editNotes').value.trim();
        bookings[currentEditIndex].الحالة = document.getElementById('editStatus').value;
        bookings[currentEditIndex].الإحداثيات = coords;
        bookings[currentEditIndex].اسم_الوكيل = document.getElementById('editAgent').value.trim();
        bookings[currentEditIndex].اسم_المستخدم = document.getElementById('editPppoeUsername').value.trim();
        saveBookings();
        document.getElementById('editOfferModal').style.display = 'none';
        alert('تم تعديل الحجز بنجاح!');
        renderBookingsTable(currentSearchQuery);
    } catch (error) {
        console.error('خطأ في حفظ تعديل الحجز:', error);
        alert('حدث خطأ أثناء حفظ التعديل.');
    }
});
document.getElementById('closeEditOfferBtn').addEventListener('click', () => {
    try {
        document.getElementById('editOfferModal').style.display = 'none';
        if (editMarker) {
            editMap.removeLayer(editMarker);
            editMarker = null;
        }
    } catch (error) {
        console.error('خطأ في إغلاق نافذة تعديل الحجز:', error);
    }
});
document.getElementById('editOffersContainer').addEventListener('change', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (selectedRadio && selectedRadio.value === 'manual') {
            document.getElementById('editManualOffer').style.display = 'block';
        } else {
            document.getElementById('editManualOffer').style.display = 'none';
        }
    } catch (error) {
        console.error('خطأ في تحديث نافذة تعديل الحجز:', error);
    }
});
document.getElementById('editManualOffer').addEventListener('input', () => {
    try {
        if (document.getElementById('edit-offer-manual').checked) {
            document.getElementById('editManualOffer').value;
        }
    } catch (error) {
        console.error('خطأ في تحديث العرض اليدوي:', error);
    }
});
document.getElementById('editLocateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
        alert('المتصفح لا يدعم تحديد الموقع.');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            document.getElementById('editLat').value = lat.toFixed(6);
            document.getElementById('editLng').value = lng.toFixed(6);
            if (editMarker) editMap.removeLayer(editMarker);
            editMarker = L.marker([lat, lng]).addTo(editMap);
            editMap.flyTo([lat, lng], 16);
        },
        err => {
            let message;
            switch (err.code) {
                case err.PERMISSION_DENIED: message = 'تم رفض الوصول إلى الموقع.'; break;
                case err.POSITION_UNAVAILABLE: message = 'معلومات الموقع غير متوفرة.'; break;
                case err.TIMEOUT: message = 'انتهت مهلة طلب الموقع.'; break;
                default: message = 'خطأ غير معروف: ' + err.message;
            }
            alert('فشل في الحصول على الموقع: ' + message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
});
document.getElementById('editPickBtn').addEventListener('click', () => {
    alert('اضغط على الخريطة لتحديد الموقع.');
    const onClick = (e) => {
        document.getElementById('editLat').value = e.latlng.lat.toFixed(6);
        document.getElementById('editLng').value = e.latlng.lng.toFixed(6);
        if (editMarker) editMap.removeLayer(editMarker);
        editMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(editMap);
        editMap.flyTo([e.latlng.lat, e.latlng.lng], 16);
        editMap.off('click', onClick);
    };
    editMap.on('click', onClick);
});
document.getElementById('editClearBtn').addEventListener('click', () => {
    document.getElementById('editLat').value = '';
    document.getElementById('editLng').value = '';
    if (editMarker) {
        editMap.removeLayer(editMarker);
        editMarker = null;
    }
});

// ======= الخريطة =======
const map = L.map('map', {zoomControl: true}).setView([36.3719, 43.1228], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap contributors'}).addTo(map);
let marker = null;
const coordsEl = document.getElementById('coords');
const latEl = document.getElementById('lat');
const lngEl = document.getElementById('lng');
function setCoords(lat, lng) {
    try {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.flyTo([lat, lng], 16);
        coordsEl.textContent = lat.toFixed(6) + ' , ' + lng.toFixed(6);
        latEl.value = lat;
        lngEl.value = lng;
    } catch (error) {
        console.error('خطأ في تحديد الإحداثيات:', error);
    }
}
document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) { alert('المتصفح لا يدعم تحديد الموقع.'); return; }
    navigator.geolocation.getCurrentPosition(
        pos => { setCoords(pos.coords.latitude, pos.coords.longitude); },
        err => {
            let message;
            switch (err.code) {
                case err.PERMISSION_DENIED: message = 'تم رفض الوصول إلى الموقع. يرجى السماح بالوصول.'; break;
                case err.POSITION_UNAVAILABLE: message = 'معلومات الموقع غير متوفرة.'; break;
                case err.TIMEOUT: message = 'انتهت مهلة طلب الموقع.'; break;
                default: message = 'خطأ غير معروف: ' + err.message;
            }
            alert('فشل في الحصول على الموقع: ' + message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
});
document.getElementById('pickBtn').addEventListener('click', () => {
    alert('اضغط على الخريطة لتحديد الموقع.');
    const onClick = (e) => { setCoords(e.latlng.lat, e.latlng.lng); map.off('click', onClick); };
    map.on('click', onClick);
});
document.getElementById('clearBtn').addEventListener('click', () => {
    try {
        if (marker) map.removeLayer(marker);
        marker = null;
        coordsEl.textContent = 'لم يتم التحديد';
        latEl.value = '';
        lngEl.value = '';
    } catch (error) {
        console.error('خطأ في محو الإحداثيات:', error);
    }
});

// ======= العروض =======
const offersContainer = document.getElementById('offersContainer');
const offerDetails = document.getElementById('offerDetails');
const manualOfferInput = document.getElementById('manualOffer');
function renderOffers() {
    try {
        offersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'offer';
            radio.value = key;
            radio.id = 'offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            offersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'offer';
        manualRadio.value = 'manual';
        manualRadio.id = 'offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' كتابة العرض يدوياً'));
        offersContainer.appendChild(manualLabel);
        const firstRadio = hasOffers ? document.querySelector('input[name="offer"]') : document.getElementById('offer-manual');
        if (firstRadio) firstRadio.checked = true;
        updateOfferDetails();
        updateStats();
    } catch (error) {
        console.error('خطأ في عرض العروض:', error);
        alert('حدث خطأ أثناء تحميل العروض. يرجى إعادة تحميل الصفحة.');
    }
}
function updateOfferDetails() {
    try {
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            offerDetails.textContent = 'اختر عرضاً لرؤية التفاصيل هنا.';
            manualOfferInput.style.display = 'none';
            return;
        }
        const selectedValue = selectedRadio.value;
        if (selectedValue === 'manual') {
            manualOfferInput.style.display = 'block';
            offerDetails.textContent = manualOfferInput.value || 'اكتب العرض هنا.';
        } else {
            manualOfferInput.style.display = 'none';
            offerDetails.textContent = offerInfo[selectedValue] ? 
                offerInfo[selectedValue].description + ' — السعر: ' + offerInfo[selectedValue].price : 
                'تفاصيل العرض غير متوفرة';
        }
    } catch (error) {
        console.error('خطأ في تحديث تفاصيل العرض:', error);
    }
}
renderOffers();
offersContainer.addEventListener('change', updateOfferDetails);
manualOfferInput.addEventListener('input', () => {
    try {
        if (document.getElementById('offer-manual').checked) {
            offerDetails.textContent = manualOfferInput.value || 'اكتب العرض هنا.';
        }
    } catch (error) {
        console.error('خطأ في تحديث تفاصيل العرض اليدوي:', error);
    }
});

// ======= إدارة العروض (مودال) =======
const manageOffersBtn = document.getElementById('manageOffersBtn');
const offersModal = document.getElementById('offersModal');
const offersList = document.getElementById('offersList');
const addOfferBtn = document.getElementById('addOfferBtn');
const saveOffersBtn = document.getElementById('saveOffersBtn');
const closeOffersBtn = document.getElementById('closeOffersBtn');
function renderOffersModal() {
    try {
        offersList.innerHTML = '';
        for (let key in offerInfo) {
            const div = document.createElement('div');
            div.className = 'offer-item';
            div.innerHTML = `
                <div><label>اسم العرض:</label><input type="text" value="${key}" class="offerName" placeholder="اسم العرض"></div>
                <div><label>وصف العرض:</label><input type="text" value="${offerInfo[key].description}" class="offerDesc" placeholder="وصف العرض"></div>
                <div><label>السعر:</label><input type="text" value="${offerInfo[key].price}" class="offerPrice" placeholder="السعر"></div>
                <button type="button" class="removeOfferBtn">حذف العرض</button>
            `;
            offersList.appendChild(div);
            div.querySelector('.removeOfferBtn').addEventListener('click', function() {
                if (Object.keys(offerInfo).length <= 1) {
                    alert('يجب أن يكون هناك عرض واحد على الأقل.');
                    return;
                }
                div.remove();
            });
        }
    } catch (error) {
        console.error('خطأ في عرض نافذة إدارة العروض:', error);
    }
}
addOfferBtn.addEventListener('click', function() {
    try {
        const div = document.createElement('div');
        div.className = 'offer-item';
        div.innerHTML = `
            <div><label>اسم العرض:</label><input type="text" placeholder="اسم العرض" class="offerName"></div>
            <div><label>وصف العرض:</label><input type="text" placeholder="وصف العرض" class="offerDesc"></div>
            <div><label>السعر:</label><input type="text" placeholder="السعر" class="offerPrice"></div>
            <button type="button" class="removeOfferBtn">حذف العرض</button>
        `;
        offersList.appendChild(div);
        div.querySelector('.removeOfferBtn').addEventListener('click', function() {
            if (offersList.children.length <= 1) {
                alert('يجب أن يكون هناك عرض واحد على الأقل.');
                return;
            }
            div.remove();
        });
    } catch (error) {
        console.error('خطأ في إضافة عرض جديد:', error);
    }
});
manageOffersBtn.addEventListener('click', function() {
    try {
        renderOffersModal();
        offersModal.style.display = 'flex';
    } catch (error) {
        console.error('خطأ في فتح نافذة إدارة العروض:', error);
    }
});
closeOffersBtn.addEventListener('click', function() {
    try {
        offersModal.style.display = 'none';
    } catch (error) {
        console.error('خطأ في إغلاق نافذة إدارة العروض:', error);
    }
});
saveOffersBtn.addEventListener('click', function() {
    try {
        const newOffers = {};
        let hasError = false;
        const names = new Set();
        offersList.querySelectorAll('.offer-item').forEach(div => {
            const name = div.querySelector('.offerName').value.trim();
            const desc = div.querySelector('.offerDesc').value.trim();
            const price = div.querySelector('.offerPrice').value.trim();
            if (name && desc && price) {
                if (names.has(name)) {
                    hasError = true;
                    alert(`اسم العرض "${name}" مكرر. يرجى اختيار اسم مختلف.`);
                    return;
                }
                names.add(name);
                newOffers[name] = {description: desc, price: price};
            } else if (name || desc || price) {
                hasError = true;
            }
        });
        if (hasError) {
            alert('يرجى ملء جميع الحقول لكل عرض أو حذف العروض غير المكتملة.');
            return;
        }
        if (Object.keys(newOffers).length === 0) {
            alert('يجب إضافة عرض واحد على الأقل.');
            return;
        }
        offerInfo = newOffers;
        localStorage.setItem('offerInfo', JSON.stringify(offerInfo));
        renderOffers();
        offersModal.style.display = 'none';
        alert("تم حفظ العروض بنجاح!");
    } catch (error) {
        console.error('خطأ في حفظ العروض:', error);
        alert('حدث خطأ أثناء حفظ العروض. يرجى المحاولة مرة أخرى.');
    }
});

// ======= الحجوزات =======
function saveBookings() {
    try {
        console.log('حفظ الحجوزات:', bookings);
        localStorage.setItem('bookings', JSON.stringify(bookings));
        bookings = JSON.parse(localStorage.getItem('bookings')) || [];
        console.log('الحجوزات بعد الحفظ:', bookings);
        updateStats();
        renderBookingsTable(currentSearchQuery);
    } catch (error) {
        console.error('خطأ في حفظ الحجوزات:', error);
        alert('حدث خطأ أثناء حفظ الحجوزات.');
    }
}
updateStats();
const form = document.getElementById('bookingForm');
const phoneInput = document.getElementById('phone');
form.addEventListener('submit', function(e) {
    e.preventDefault();
    try {
        const name = form.name.value.trim();
        if (!name) {
            alert('يرجى إدخال الاسم.');
            return;
        }
        let phone = phoneInput.value.trim().replace(/[\s+()-]/g, '');
        if (!phone) {
            alert('يرجى إدخال رقم هاتف.');
            return;
        }
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            alert('يرجى اختيار عرض أو كتابة عرض يدوي.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? manualOfferInput.value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('يرجى كتابة تفاصيل العرض اليدوي.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' — السعر: ' + offerInfo[selectedOffer].price : selectedOffer);
        const data = {
            الاسم: name,
            الهاتف: phone,
            اسم_الوكيل: form.agent.value.trim(),
            اسم_المستخدم: form.pppoeUsername.value.trim(),
            العرض: offerText,
            التفاصيل: offerDesc,
            الإحداثيات: latEl.value && lngEl.value ? `${latEl.value}, ${lngEl.value}` : "غير محدد",
            ملاحظات: form.notes.value.trim(),
            الحالة: form.status.value,
            التاريخ: new Date().toISOString()
        };
        console.log('حجز جديد:', data);
        bookings.push(data);
        saveBookings();
        const phoneNumber = "9647512328848";
        const message = encodeURIComponent(`📢 حجز جديد:
👤 الاسم: ${data.الاسم}
📞 الهاتف: ${data.الهاتف}
👷 اسم الوكيل: ${data.اسم_الوكيل || 'غير محدد'}
🖥️ Username PPPoE: ${data.اسم_المستخدم || 'غير محدد'}
📦 العرض: ${data.العرض}
📍 الإحداثيات: ${data.الإحداثيات}
📝 ملاحظات: ${data.ملاحظات.substring(0, 500)}
📅 التاريخ: ${new Date(data.التاريخ).toLocaleString('ar-IQ')}
📊 الحالة: ${data.الحالة}`);
        window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        alert("تم حفظ الحجز وإرساله على واتساب!");
        form.reset();
        if (marker) {
            map.removeLayer(marker);
            marker = null;
            coordsEl.textContent = 'لم يتم التحديد';
            latEl.value = '';
            lngEl.value = '';
        }
        renderOffers();
    } catch (error) {
        console.error('خطأ في إرسال الحجز:', error);
        alert('حدث خطأ أثناء حفظ الحجز أو إرساله. يرجى المحاولة مرة أخرى.');
    }
});

// ======= تصدير Excel =======
function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}
document.getElementById('exportBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("لا توجد حجوزات لتصديرها!");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "حجوزات");
        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
        const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "حجوزات_العملاء.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطأ في تصدير Excel:', error);
        alert('حدث خطأ أثناء تصدير الحجوزات.');
    }
});

// ======= نسخة احتياطية يومية =======
document.getElementById('backupBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("لا توجد حجوزات للنسخة الاحتياطية!");
            return;
        }
        const date = new Date().toISOString().split('T')[0];
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "حجوزات");
        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
        const xlsxBlob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
        const xlsxUrl = URL.createObjectURL(xlsxBlob);
        const xlsxA = document.createElement("a");
        xlsxA.href = xlsxUrl;
        xlsxA.download = `backup_${date}.xlsx`;
        document.body.appendChild(xlsxA);
        xlsxA.click();
        document.body.removeChild(xlsxA);
        URL.revokeObjectURL(xlsxUrl);
        const jsonBlob = new Blob([JSON.stringify(bookings, null, 2)], {type: "application/json"});
        const jsonUrl = URL.createObjectURL(jsonBlob);
        const jsonA = document.createElement('a');
        jsonA.href = jsonUrl;
        jsonA.download = `backup_${date}.json`;
        document.body.appendChild(jsonA);
        jsonA.click();
        document.body.removeChild(jsonA);
        URL.revokeObjectURL(jsonUrl);
        alert("تم إنشاء النسخة الاحتياطية بنجاح!");
    } catch (error) {
        console.error('خطأ في إنشاء النسخة الاحتياطية:', error);
        alert('حدث خطأ أثناء إنشاء النسخة الاحتياطية.');
    }
});

// ======= استيراد JSON =======
const importInput = document.getElementById('importJSON');
document.getElementById('importBtn').addEventListener('click', () => {
    importInput.click();
});
importInput.addEventListener('change', function(e) {
    try {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const imported = JSON.parse(evt.target.result);
                if (Array.isArray(imported)) {
                    const validBookings = imported.filter(booking => 
                        booking && booking.الاسم && booking.الهاتف && booking.العرض
                    );
                    bookings = validBookings;
                    saveBookings();
                    alert("تم استيراد JSON بنجاح!");
                } else {
                    alert("ملف غير صالح");
                }
            } catch (err) {
                console.error('خطأ في قراءة ملف JSON:', err);
                alert("خطأ في قراءة الملف: " + err.message);
            }
        };
        reader.readAsText(file);
    } catch (error) {
        console.error('خطأ في استيراد JSON:', error);
        alert('حدث خطأ أثناء استيراد الملف.');
    }
});

// ======= محو كل الحجوزات =======
document.getElementById('clearAllBtn').addEventListener('click', () => {
    try {
        if (confirm("هل أنت متأكد من محو كل الحجوزات؟")) {
            bookings = [];
            saveBookings();
            alert("تم مسح كل الحجوزات");
        }
    } catch (error) {
        console.error('خطأ في محو الحجوزات:', error);
        alert('حدث خطأ أثناء محو الحجوزات.');
    }
});

// ======= معالجة ملفات Excel (غير مستخدم حاليًا) =======
var gk_isXlsx = false;
var gk_xlsxFileLookup = {};
var gk_fileData = {};
function filledCell(cell) {
    return cell !== '' && cell != null;
}
function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            var filteredData = jsonData.filter(row => row.some(filledCell));
            var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
            }
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
}
</script>
</body>
</html>
