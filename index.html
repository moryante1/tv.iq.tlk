<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ù†Ù…ÙˆØ°Ø¬ Ø­Ø¬Ø² Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” Ù…ÙˆØ¯Ø±Ù†</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
    --bg: #f5f7fa;
    --card: #ffffff;
    --accent: #0ea5e9;
    --accent-hover: #0284c7;
    --muted: #6b7280;
    --text: #111827;
    color-scheme: light;
}

body {
    font-family: 'Segoe UI', Tahoma, Arial, Helvetica, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: clamp(1rem, 3vw, 1.5rem); /* Adaptive padding */
    font-size: clamp(13px, 3.8vw, 15px); /* Responsive font size */
    line-height: 1.5;
}

.container {
    max-width: 1000px;
    margin: clamp(1rem, 3vw, 2rem) auto;
    padding: clamp(12px, 2.5vw, 20px);
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

h1 {
    font-size: clamp(18px, 5vw, 26px); /* Responsive heading */
    margin: 0 0 clamp(1rem, 2vw, 1.5rem);
    text-align: center;
    color: var(--accent);
}

form {
    display: grid;
    gap: clamp(0.8rem, 2vw, 1rem);
}

label {
    font-size: clamp(13px, 3.5vw, 14px);
    color: var(--muted);
}

input[type="text"],
input[type="tel"],
textarea,
select {
    width: 100%;
    padding: clamp(8px, 2vw, 10px);
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: var(--text);
    font-size: clamp(13px, 3.5vw, 14px);
    transition: border 0.2s, box-shadow 0.2s;
    -webkit-appearance: none; /* Fix iOS input styling */
}

input[type="text"]:focus,
input[type="tel"]:focus,
textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
}

.row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Flexible grid */
    gap: clamp(0.8rem, 2vw, 1rem);
}

#map {
    height: clamp(180px, 35vh, 350px); /* Responsive map height */
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    width: 100%;
    touch-action: pinch-zoom; /* Allow pinch-zoom on map */
}

.offers {
    background: #f3f4f6;
    padding: clamp(8px, 2vw, 10px);
    border-radius: 8px;
}

.offers label {
    display: block;
    padding: clamp(5px, 1.5vw, 6px) 0;
    cursor: pointer;
    font-size: clamp(12px, 3.2vw, 13px);
}

.btn {
    display: inline-block;
    padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-size: clamp(13px, 3.5vw, 14px);
    touch-action: manipulation; /* Improve touch responsiveness */
    transition: background 0.2s, transform 0.1s;
}

.btn:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
}

.muted {
    font-size: clamp(11px, 3vw, 12px);
    color: var(--muted);
}

img.logo {
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    max-width: clamp(100px, 20vw, 120px); /* Responsive logo */
}

#manualOffer {
    padding: clamp(6px, 1.5vw, 8px);
    border-radius: 8px;
    border: 1px solid #d1d5db;
    width: 100%;
    display: none;
    margin-top: 8px;
}

#offerDetails {
    margin-top: 8px;
    padding: clamp(6px, 1.5vw, 8px);
    background: #eef2f7;
    border-radius: 8px;
    font-size: clamp(12px, 3.2vw, 13px);
}

#offersModal,
#editOfferModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

#offersModal > div,
#editOfferModal > div {
    background: #fff;
    padding: clamp(12px, 3vw, 16px);
    border-radius: 10px;
    max-width: clamp(300px, 90vw, 450px); /* Responsive modal width */
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
}

.stats-section {
    background: #f8fafc;
    padding: clamp(12px, 2.5vw, 16px);
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
}

.stats-title {
    font-size: clamp(16px, 4vw, 18px);
    font-weight: 600;
    margin-bottom: clamp(8px, 2vw, 12px);
    color: var(--accent);
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Responsive stats */
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: 12px;
}

.stat-card {
    background: white;
    padding: clamp(8px, 2vw, 12px);
    border-radius: 8px;
    text-align: center;
    border-right: 4px solid var(--accent);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.stat-card.today {
    border-right-color: #10b981;
}

.stat-card.offers {
    border-right-color: #f59e0b;
}

.stat-value {
    font-size: clamp(20px, 5vw, 22px);
    font-weight: 700;
    margin: 4px 0;
    color: var(--text);
}

.stat-label {
    font-size: clamp(11px, 3vw, 12px);
    color: var(--muted);
}

.popular-offers {
    background: white;
    padding: clamp(8px, 2vw, 12px);
    border-radius: 8px;
    margin-top: 8px;
}

.offer-stat {
    display: flex;
    justify-content: space-between;
    padding: clamp(5px, 1.5vw, 6px) 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: clamp(12px, 3.2vw, 13px);
}

.offer-stat:last-child {
    border-bottom: none;
}

.offer-name {
    font-weight: 500;
}

.offer-count {
    color: var(--accent);
    font-weight: 600;
}

.bookings-section {
    background: #f8fafc;
    padding: clamp(12px, 2.5vw, 16px);
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    margin-top: 1rem;
}

.bookings-title {
    font-size: clamp(16px, 4vw, 18px);
    font-weight: 600;
    margin-bottom: clamp(8px, 2vw, 12px);
    color: var(--accent);
    text-align: center;
}

#bookingsTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: clamp(12px, 2.5vw, 16px);
    font-size: clamp(11px, 3vw, 13px);
}

#bookingsTable th,
#bookingsTable td {
    border: 1px solid #e5e7eb;
    padding: clamp(5px, 1.5vw, 7px);
    text-align: right;
}

#bookingsTable th {
    background: #f1f5f9;
    font-weight: 600;
}

#bookingsTable tr:nth-child(even) {
    background: #f9fafb;
}

#bookingsTable .edit-btn {
    background: #f59e0b;
    padding: clamp(5px, 1.5vw, 6px) clamp(8px, 2vw, 10px);
    border-radius: 4px;
    color: white;
    border: none;
    cursor: pointer;
    font-size: clamp(11px, 3vw, 12px);
}

#bookingsTable .edit-btn:hover {
    background: #d97706;
}

.offer-item {
    margin-bottom: clamp(8px, 2vw, 10px);
    padding: clamp(8px, 2vw, 10px);
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
}

.offer-item input {
    width: 100%;
    padding: clamp(6px, 1.5vw, 8px);
    margin-bottom: 5px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: clamp(12px, 3.2vw, 13px);
}

.removeOfferBtn {
    background: #f87171;
    color: white;
    border: none;
    padding: clamp(5px, 1.5vw, 6px) clamp(8px, 2vw, 10px);
    border-radius: 4px;
    cursor: pointer;
    margin-top: 5px;
    font-size: clamp(11px, 3vw, 12px);
}

.removeOfferBtn:hover {
    background: #ef4444;
}

/* Media queries for small screens (Android/iOS) */
@media (max-width: 480px) {
    body {
        padding: 0.5rem;
    }
    .container {
        margin: 0.5rem;
        padding: 0.75rem;
    }
    .row {
        grid-template-columns: 1fr;
    }
    #map {
        height: 25vh; /* Smaller map for small screens */
    }
    .btn {
        width: 100%; /* Full-width buttons */
        margin-bottom: 0.5rem;
        font-size: clamp(12px, 3.5vw, 13px);
    }
    #offersModal > div,
    #editOfferModal > div {
        width: 95vw;
        padding: 0.75rem;
    }
    #bookingsTable th,
    #bookingsTable td {
        padding: clamp(4px, 1vw, 5px);
        font-size: clamp(10px, 2.8vw, 11px);
    }
}

/* Media queries for medium screens (tablets) */
@media (max-width: 768px) {
    .container {
        margin: 1rem;
        padding: 1rem;
    }
    .stats-grid {
        grid-template-columns: 1fr;
    }
    .row {
        grid-template-columns: 1fr;
    }
}

/* Media queries for small Windows screens (e.g., 1366x768) */
@media (max-width: 1366px) and (min-width: 769px) {
    .container {
        max-width: 90%;
    }
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
}

/* iOS-specific fixes */
@supports (-webkit-overflow-scrolling: touch) {
    input, textarea, select {
        -webkit-appearance: none;
        border-radius: 8px;
        font-size: 16px; /* Prevent iOS zoom on input focus */
    }
    body {
        -webkit-text-size-adjust: 100%; /* Prevent iOS font scaling */
    }
}

/* Android-specific fixes */
@media (hover: none) and (pointer: coarse) {
    .btn {
        padding: clamp(10px, 2.5vw, 12px) clamp(14px, 3.5vw, 18px); /* Larger touch targets */
    }
    #map {
        touch-action: auto; /* Ensure smooth scrolling on Android */
    }
}
</style>
</head>
<body>
<div class="container">
    <div style="text-align:center; margin-bottom:12px;">
        <img src="https://reseller.nbtel.iq/nb_logo.png" alt="Ø´Ø¹Ø§Ø± NBTEL" class="logo" style="width:120px; height:auto;">
    </div>
    <h1>Ø­Ø¬ÙˆØ²Ø§Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” ØªÙ„ÙƒÙŠÙ</h1>
    <div class="stats-section">
        <div class="stats-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
                <div class="stat-value" id="totalBookings">0</div>
            </div>
            <div class="stat-card today">
                <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                <div class="stat-value" id="todayBookings">0</div>
            </div>
            <div class="stat-card offers">
                <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                <div class="stat-value" id="totalOffers">0</div>
            </div>
        </div>
        <div class="popular-offers">
            <div style="font-weight:600; margin-bottom:8px; color:var(--muted); font-size:clamp(12px, 3.2vw, 13px);">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹:</div>
            <div id="popularOffers">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</div>
        </div>
    </div>
    <form id="bookingForm" autocomplete="on" novalidate>
        <div class="row">
            <div>
                <label for="name" aria-label="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø§Ù„Ø§Ø³Ù…</label>
                <input id="name" name="name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ" required aria-required="true">
            </div>
            <div>
                <label for="phone" aria-label="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="phone" name="phone" type="tel" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required aria-required="true">
            </div>
        </div>
        <div>
            <label id="offer-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶</label>
            <div class="offers" id="offersContainer" role="radiogroup" aria-labelledby="offer-label"></div>
            <input type="text" id="manualOffer" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§..." style="display:none;" aria-label="Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ">
            <div id="offerDetails" aria-live="polite">Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.</div>
            <button type="button" class="btn" style="background:#6366f1;margin-top:8px" id="manageOffersBtn" aria-label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
        </div>
        <div>
            <label>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
            <div id="map"></div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button type="button" id="locateBtn" class="btn" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                <button type="button" id="pickBtn" class="btn" aria-label="Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø©</button>
                <button type="button" id="clearBtn" class="btn" style="background:#f87171" aria-label="Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª">Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
            </div>
            <div class="muted" style="margin-top:8px">Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø®ØªØ§Ø±Ø©: <span id="coords">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</span></div>
        </div>
        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lng" name="lng">
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;flex-wrap:wrap">
            <button type="submit" class="btn" aria-label="Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ±Ø¯ÙŠ</button>
            <button type="button" id="exportBtn" class="btn" style="background:#38bdf8" aria-label="ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel">ØªØµØ¯ÙŠØ± Excel</button>
            <button type="button" id="backupBtn" class="btn" style="background:#16a34a" aria-label="Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ©">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ©</button>
            <input type="file" id="importJSON" style="display:none" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON">
            <button type="button" class="btn" style="background:#f59e0b" id="importBtn" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <button type="button" class="btn" style="background:#f87171" id="clearAllBtn" aria-label="Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
            <button type="button" class="btn" style="background:#ef4444" id="clearTodayBtn" aria-label="Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…">Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
            <button type="button" class="btn" style="background:#6b7280" id="toggleTableBtn" aria-label="Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
    </form>
    <div class="bookings-section" id="bookingsSection">
        <div class="bookings-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <table id="bookingsTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø§Ù„Ø¹Ø±Ø¶</th>
                    <th>ØªØ¹Ø¯ÙŠÙ„</th>
                </tr>
            </thead>
            <tbody id="bookingsTableBody"></tbody>
        </table>
    </div>
</div>
<div id="offersModal" role="dialog" aria-labelledby="offersModalTitle" aria-hidden="true">
    <div>
        <h2 id="offersModalTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h2>
        <div id="offersList"></div>
        <button type="button" class="btn" id="addOfferBtn" style="background:#10b981;margin-top:8px" aria-label="Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯">Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</button>
        <div style="margin-top:12px;text-align:right;">
            <button type="button" class="btn" id="saveOffersBtn" aria-label="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button type="button" class="btn" style="background:#f87171" id="closeOffersBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>
<div id="editOfferModal" role="dialog" aria-labelledby="editOfferModalTitle" aria-hidden="true">
    <div>
        <h2 id="editOfferModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</h2>
        <div class="offers" id="editOffersContainer" role="radiogroup" aria-labelledby="editOfferModalTitle"></div>
        <input type="text" id="editManualOffer" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹..." style="display:none;" aria-label="Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ">
        <div style="margin-top:12px;text-align:right;">
            <button type="button" class="btn" id="saveEditOfferBtn" aria-label="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button type="button" class="btn" style="background:#f87171" id="closeEditOfferBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======= Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =======
let bookings = JSON.parse(localStorage.getItem('bookings')) || [];
let offerInfo = JSON.parse(localStorage.getItem('offerInfo')) || {
    "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„": {description: "Ø±Ø§ÙˆØªØ± ONT ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ†ØµÙŠØ¨ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ¨", price: "85,000 Ø¯.Ø¹"},
    "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø«Ø§Ù†ÙŠ": {description: "Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø± Ù…Ø¹ Ø®Ø¯Ù…Ø© 1001", price: "45,000 Ø¯.Ø¹"},
    "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø«Ø§Ù„Ø«": {description: "Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø§ ØªØ¨Ù‚Ù‰ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯", price: "35,000 Ø¯.Ø¹"}
};

function updateStats() {
    try {
        document.getElementById('totalBookings').textContent = bookings.length;
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(booking => {
            if (!booking.Ø§Ù„ØªØ§Ø±ÙŠØ®) return false;
            const bookingDate = new Date(booking.Ø§Ù„ØªØ§Ø±ÙŠØ®).toISOString().split('T')[0];
            return bookingDate === today;
        }).length;
        document.getElementById('todayBookings').textContent = todayBookings;
        const uniqueOffers = new Set(bookings.map(booking => booking.Ø§Ù„Ø¹Ø±Ø¶).filter(offer => offer));
        const totalOffers = Object.keys(offerInfo).length + (uniqueOffers.size - Object.keys(offerInfo).filter(offer => uniqueOffers.has(offer)).length);
        document.getElementById('totalOffers').textContent = totalOffers;
        updatePopularOffers();
        renderBookingsTable();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    }
}

function updatePopularOffers() {
    try {
        if (bookings.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:clamp(11px, 3vw, 12px);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯</div>';
            return;
        }
        const offerCounts = {};
        bookings.forEach(booking => {
            const offer = booking.Ø§Ù„Ø¹Ø±Ø¶ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            offerCounts[offer] = (offerCounts[offer] || 0) + 1;
        });
        const sortedOffers = Object.entries(offerCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        if (sortedOffers.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:clamp(11px, 3vw, 12px);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</div>';
            return;
        }
        let html = '';
        sortedOffers.forEach(([offer, count]) => {
            html += `<div class="offer-stat"><span class="offer-name">${offer}</span><span class="offer-count">${count} Ø­Ø¬Ø²</span></div>`;
        });
        document.getElementById('popularOffers').innerHTML = html;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:', error);
    }
}

// ======= Ø§Ù„Ø¬Ø¯ÙˆÙ„ =======
function renderBookingsTable() {
    try {
        const tbody = document.getElementById('bookingsTableBody');
        const fragment = document.createDocumentFragment();
        if (bookings.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align:center;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</td>';
            fragment.appendChild(tr);
        } else {
            bookings.forEach((booking, index) => {
                if (!booking || !booking.Ø§Ù„Ø§Ø³Ù… || !booking.Ø§Ù„Ù‡Ø§ØªÙ || !booking.Ø§Ù„Ø¹Ø±Ø¶) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${booking.Ø§Ù„Ø§Ø³Ù… || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${booking.Ø§Ù„Ù‡Ø§ØªÙ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${booking.Ø§Ù„Ø¹Ø±Ø¶ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td><button class="edit-btn" data-index="${index}" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ ${booking.Ø§Ù„Ø¹Ø±Ø¶}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</button></td>
                `;
                fragment.appendChild(tr);
            });
        }
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.removeEventListener('click', openEditOfferModal); // Prevent duplicate listeners
            btn.addEventListener('click', () => openEditOfferModal(btn.getAttribute('data-index')));
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
}

// ======= Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =======
const toggleTableBtn = document.getElementById('toggleTableBtn');
const bookingsSection = document.getElementById('bookingsSection');
toggleTableBtn.addEventListener('click', () => {
    try {
        if (bookingsSection.style.display === 'none') {
            bookingsSection.style.display = 'block';
            toggleTableBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
            renderBookingsTable();
        } else {
            bookingsSection.style.display = 'none';
            toggleTableBtn.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
    }
});

// ======= Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ… =======
document.getElementById('clearTodayBtn').addEventListener('click', () => {
    try {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ')) {
            const today = new Date().toISOString().split('T')[0];
            bookings = bookings.filter(booking => {
                if (!booking.Ø§Ù„ØªØ§Ø±ÙŠØ®) return true;
                const bookingDate = new Date(booking.Ø§Ù„ØªØ§Ø±ÙŠØ®).toISOString().split('T')[0];
                return bookingDate !== today;
            });
            saveBookings();
            alert('ØªÙ… Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ….');
    }
});

// ======= ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ =======
let currentEditIndex = null;
function openEditOfferModal(index) {
    try {
        currentEditIndex = index;
        const editOffersContainer = document.getElementById('editOffersContainer');
        editOffersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'editOffer';
            radio.value = key;
            radio.id = 'edit-offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            editOffersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'editOffer';
        manualRadio.value = 'manual';
        manualRadio.id = 'edit-offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'edit-offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹'));
        editOffersContainer.appendChild(manualLabel);
        const editManualOfferInput = document.getElementById('editManualOffer');
        editManualOfferInput.style.display = 'none';
        editManualOfferInput.value = '';
        const currentOffer = bookings[index].Ø§Ù„Ø¹Ø±Ø¶ || '';
        const isManual = !offerInfo[currentOffer];
        if (isManual) {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
            editManualOfferInput.value = currentOffer;
        } else if (hasOffers) {
            const offerRadio = document.querySelector(`input[name="editOffer"][value="${currentOffer}"]`);
            if (offerRadio) offerRadio.checked = true;
            else document.getElementById('edit-offer-manual').checked = true;
        } else {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
        }
        document.getElementById('editOfferModal').style.display = 'flex';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
    }
}

document.getElementById('saveEditOfferBtn').addEventListener('click', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (!selectedRadio) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? document.getElementById('editManualOffer').value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedOffer].price : selectedOffer);
        bookings[currentEditIndex].Ø§Ù„Ø¹Ø±Ø¶ = offerText;
        bookings[currentEditIndex].Ø§Ù„ØªÙØ§ØµÙŠÙ„ = offerDesc;
        saveBookings();
        document.getElementById('editOfferModal').style.display = 'none';
        alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
    }
});

document.getElementById('closeEditOfferBtn').addEventListener('click', () => {
    try {
        document.getElementById('editOfferModal').style.display = 'none';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
    }
});

document.getElementById('editOffersContainer').addEventListener('change', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (selectedRadio && selectedRadio.value === 'manual') {
            document.getElementById('editManualOffer').style.display = 'block';
        } else {
            document.getElementById('editManualOffer').style.display = 'none';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
    }
});

document.getElementById('editManualOffer').addEventListener('input', () => {
    try {
        if (document.getElementById('edit-offer-manual').checked) {
            document.getElementById('editManualOffer').value;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
    }
});

// ======= Ø§Ù„Ø®Ø±ÙŠØ·Ø© =======
let map;
try {
    map = L.map('map', {zoomControl: true, doubleClickZoom: false}).setView([36.3719, 43.1228], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
} catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:', error);
    alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
}

let marker = null;
const coordsEl = document.getElementById('coords');
const latEl = document.getElementById('lat');
const lngEl = document.getElementById('lng');

function setCoords(lat, lng) {
    try {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.flyTo([lat, lng], 16);
        coordsEl.textContent = lat.toFixed(6) + ' , ' + lng.toFixed(6);
        latEl.value = lat;
        lngEl.value = lng;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:', error);
    }
}

// Add touch support for map
map.on('touchend', (e) => {
    if (e.originalEvent.touches.length === 1) {
        const touch = e.originalEvent.changedTouches[0];
        const latlng = map.mouseEventToLatLng(touch);
        setCoords(latlng.lat, latlng.lng);
    }
});

document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            setCoords(pos.coords.latitude, pos.coords.longitude);
        },
        err => {
            let message;
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    message = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.';
                    break;
                case err.POSITION_UNAVAILABLE:
                    message = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.';
                    break;
                case err.TIMEOUT:
                    message = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                    break;
                default:
                    message = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ' + err.message;
            }
            alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
});

document.getElementById('pickBtn').addEventListener('click', () => {
    alert('Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ù„Ù…Ø³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
    const onClick = (e) => {
        setCoords(e.latlng.lat, e.latlng.lng);
        map.off('click', onClick);
        map.off('touchend', onClick);
    };
    map.on('click', onClick);
    map.on('touchend', onClick);
});

document.getElementById('clearBtn').addEventListener('click', () => {
    try {
        if (marker) map.removeLayer(marker);
        marker = null;
        coordsEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
        latEl.value = '';
        lngEl.value = '';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:', error);
    }
});

// ======= Ø§Ù„Ø¹Ø±ÙˆØ¶ =======
const offersContainer = document.getElementById('offersContainer');
const offerDetails = document.getElementById('offerDetails');
const manualOfferInput = document.getElementById('manualOffer');

function renderOffers() {
    try {
        offersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'offer';
            radio.value = key;
            radio.id = 'offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            offersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'offer';
        manualRadio.value = 'manual';
        manualRadio.id = 'offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹'));
        offersContainer.appendChild(manualLabel);
        const firstRadio = hasOffers ? document.querySelector('input[name="offer"]') : document.getElementById('offer-manual');
        if (firstRadio) firstRadio.checked = true;
        updateOfferDetails();
        updateStats();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
    }
}

function updateOfferDetails() {
    try {
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            offerDetails.textContent = 'Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.';
            manualOfferInput.style.display = 'none';
            return;
        }
        const selectedValue = selectedRadio.value;
        if (selectedValue === 'manual') {
            manualOfferInput.style.display = 'block';
            offerDetails.textContent = manualOfferInput.value || 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§.';
        } else {
            manualOfferInput.style.display = 'none';
            offerDetails.textContent = offerInfo[selectedValue] ?
                offerInfo[selectedValue].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedValue].price :
                'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
    }
}

renderOffers();
offersContainer.addEventListener('change', updateOfferDetails);
manualOfferInput.addEventListener('input', () => {
    try {
        if (document.getElementById('offer-manual').checked) {
            offerDetails.textContent = manualOfferInput.value || 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§.';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
    }
});

// ======= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…ÙˆØ¯Ø§Ù„) =======
const manageOffersBtn = document.getElementById('manageOffersBtn');
const offersModal = document.getElementById('offersModal');
const offersList = document.getElementById('offersList');
const addOfferBtn = document.getElementById('addOfferBtn');
const saveOffersBtn = document.getElementById('saveOffersBtn');
const closeOffersBtn = document.getElementById('closeOffersBtn');

function renderOffersModal() {
    try {
        offersList.innerHTML = '';
        for (let key in offerInfo) {
            const div = document.createElement('div');
            div.className = 'offer-item';
            div.innerHTML = `
                <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" value="${key}" class="offerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶"></div>
                <div><label>ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" value="${offerInfo[key].description}" class="offerDesc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶"></div>
                <div><label>Ø§Ù„Ø³Ø¹Ø±:</label><input type="text" value="${offerInfo[key].price}" class="offerPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±"></div>
                <button type="button" class="removeOfferBtn">Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
            `;
            offersList.appendChild(div);
            div.querySelector('.removeOfferBtn').addEventListener('click', function() {
                if (Object.keys(offerInfo).length <= 1) {
                    alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                    return;
                }
                div.remove();
            });
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
}

addOfferBtn.addEventListener('click', function() {
    try {
        const div = document.createElement('div');
        div.className = 'offer-item';
        div.innerHTML = `
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" class="offerName"></div>
            <div><label>ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶" class="offerDesc"></div>
            <div><label>Ø§Ù„Ø³Ø¹Ø±:</label><input type="text" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="offerPrice"></div>
            <button type="button" class="removeOfferBtn">Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
        `;
        offersList.appendChild(div);
        div.querySelector('.removeOfferBtn').addEventListener('click', function() {
            if (offersList.children.length <= 1) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                return;
            }
            div.remove();
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯:', error);
    }
});

manageOffersBtn.addEventListener('click', function() {
    try {
        renderOffersModal();
        offersModal.style.display = 'flex';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
});

closeOffersBtn.addEventListener('click', function() {
    try {
        offersModal.style.display = 'none';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
});

saveOffersBtn.addEventListener('click', function() {
    try {
        const newOffers = {};
        let hasError = false;
        const names = new Set();
        offersList.querySelectorAll('.offer-item').forEach(div => {
            const name = div.querySelector('.offerName').value.trim();
            const desc = div.querySelector('.offerDesc').value.trim();
            const price = div.querySelector('.offerPrice').value.trim();
            if (name && desc && price) {
                if (names.has(name)) {
                    hasError = true;
                    alert(`Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ "${name}" Ù…ÙƒØ±Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.`);
                    return;
                }
                names.add(name);
                newOffers[name] = {description: desc, price: price};
            } else if (name || desc || price) {
                hasError = true;
            }
        });
        if (hasError) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ÙƒÙ„ Ø¹Ø±Ø¶ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©.');
            return;
        }
        if (Object.keys(newOffers).length === 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }
        offerInfo = newOffers;
        localStorage.setItem('offerInfo', JSON.stringify(offerInfo));
        renderOffers();
        offersModal.style.display = 'none';
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
});

// ======= Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =======
function saveBookings() {
    try {
        localStorage.setItem('bookings', JSON.stringify(bookings));
        bookings = JSON.parse(localStorage.getItem('bookings')) || [];
        updateStats();
        renderBookingsTable();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
}

const form = document.getElementById('bookingForm');
const phoneInput = document.getElementById('phone');

form.addEventListener('submit', function(e) {
    e.preventDefault();
    try {
        const name = form.name.value.trim();
        if (!name) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù….');
            return;
        }
        let phone = phoneInput.value.trim().replace(/[\s+()-]/g, '');
        const phoneRegex = /^\+9647[0-9]{8}$/;
        if (!phoneRegex.test(phone)) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ§Ù„Ø­ (Ù…Ø«Ø§Ù„: +9647XXXXXXXX).');
            return;
        }
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? manualOfferInput.value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedOffer].price : selectedOffer);
        const data = {
            Ø§Ù„Ø§Ø³Ù…: name,
            Ø§Ù„Ù‡Ø§ØªÙ: phone,
            Ø§Ù„Ø¹Ø±Ø¶: offerText,
            Ø§Ù„ØªÙØ§ØµÙŠÙ„: offerDesc,
            Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: latEl.value && lngEl.value ? `${latEl.value}, ${lngEl.value}` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            Ù…Ù„Ø§Ø­Ø¸Ø§Øª: form.notes.value.trim(),
            Ø§Ù„ØªØ§Ø±ÙŠØ®: new Date().toLocaleString('ar-IQ', { timeZone: 'Asia/Baghdad' })
        };
        bookings.push(data);
        saveBookings();
        const phoneNumber = "9647512328848";
        const maxMessageLength = 2000;
        let message = `ğŸ“¢ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯:
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${data.Ø§Ù„Ø§Ø³Ù…}
ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${data.Ø§Ù„Ù‡Ø§ØªÙ}
ğŸ“¦ Ø§Ù„Ø¹Ø±Ø¶: ${data.Ø§Ù„Ø¹Ø±Ø¶}
ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${data.Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª}
ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.Ù…Ù„Ø§Ø­Ø¸Ø§Øª.substring(0, 500)}
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.Ø§Ù„ØªØ§Ø±ÙŠØ®}`;
        if (encodeURIComponent(message).length > maxMessageLength) {
            message = message.substring(0, maxMessageLength);
        }
        window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨!");
        form.reset();
        if (marker) {
            map.removeLayer(marker);
            marker = null;
            coordsEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
            latEl.value = '';
            lngEl.value = '';
        }
        renderOffers();
        setTimeout(() => renderBookingsTable(), 100);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø²:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„Ù‡.');
    }
});

// ØªØµØ¯ÙŠØ± Excel
document.getElementById('exportBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø­Ø¬ÙˆØ²Ø§Øª");
        XLSX.writeFile(wb, "Ø­Ø¬ÙˆØ²Ø§Øª_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.xlsx");
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
});

// Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ©
document.getElementById('backupBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!");
            return;
        }
        const date = new Date().toISOString().split('T')[0];
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø­Ø¬ÙˆØ²Ø§Øª");
        XLSX.writeFile(wb, `backup_${date}.xlsx`);
        const blob = new Blob([JSON.stringify(bookings, null, 2)], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `backup_${date}.json`;
        link.click();
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
    }
});

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
const importInput = document.getElementById('importJSON');
document.getElementById('importBtn').addEventListener('click', () => {
    importInput.click();
});

importInput.addEventListener('change', function(e) {
    try {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const imported = JSON.parse(evt.target.result);
                if (Array.isArray(imported)) {
                    const validBookings = imported.filter(booking =>
                        booking && booking.Ø§Ù„Ø§Ø³Ù… && booking.Ø§Ù„Ù‡Ø§ØªÙ && booking.Ø§Ù„Ø¹Ø±Ø¶
                    );
                    bookings = validBookings;
                    saveBookings();
                    alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ø¨Ù†Ø¬Ø§Ø­!");
                } else {
                    alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
                }
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON:', err);
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
            }
        };
        reader.readAsText(file);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù.');
    }
});

// Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
document.getElementById('clearAllBtn').addEventListener('click', () => {
    try {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§ØªØŸ")) {
            bookings = [];
            saveBookings();
            alert("ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª");
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ùˆ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ùˆ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
});
</script>
</body>
</html>
