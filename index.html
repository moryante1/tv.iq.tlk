<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Group NBTEL - نظام الحجوزات</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* جميع الأنماط السابقة تبقى كما هي */
        /* أضف هذه الأنماط الجديدة فقط */

        .date-change-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .date-change-btn:hover {
            background: var(--info-dark);
            transform: scale(1.05);
        }

        .date-display {
            font-size: 12px;
            color: var(--muted);
            direction: ltr;
            text-align: center;
        }

        .change-date-modal .modal-content {
            max-width: 400px;
        }

        .date-picker {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            text-align: center;
        }

        .quick-date-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .quick-date-btn {
            padding: 8px;
            border: 1px solid var(--border);
            background: white;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }

        .quick-date-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .quick-date-btn.today {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .table-btn.change-date {
            background: var(--info);
            color: white;
        }
    </style>
</head>
<body>
    <!-- كل الهيكل السابق يبقى كما هو -->
    <!-- نضيف فقط المودال الجديد -->

    <!-- مودال تغيير التاريخ -->
    <div id="changeDateModal" class="modal change-date-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> تغيير تاريخ الحجز</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="selectedBookingInfo">معلومات الحجز:</label>
                    <div id="selectedBookingInfo" style="background: var(--light); padding: 10px; border-radius: var(--radius); margin-bottom: 15px;">
                        <!-- سيتم تعبئتها ديناميكياً -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newBookingDate">التاريخ الجديد:</label>
                    <input type="date" id="newBookingDate" class="date-picker">
                </div>

                <div class="quick-date-options">
                    <button class="quick-date-btn today" data-days="0">اليوم</button>
                    <button class="quick-date-btn" data-days="1">غداً</button>
                    <button class="quick-date-btn" data-days="7">أسبوع</button>
                    <button class="quick-date-btn" data-days="-1">أمس</button>
                    <button class="quick-date-btn" data-days="30">شهر</button>
                    <button class="quick-date-btn" data-days="-7">أسبوع مضى</button>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" id="saveDateChangeBtn">
                        <i class="fas fa-save"></i> حفظ التغيير
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelDateChangeBtn">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // نضيف هذه المتغيرات والدوال الجديدة
        let currentDateChangeIndex = -1;

        // دالة لتنسيق التاريخ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // دالة لعرض التاريخ في الجدول
        function formatTableDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // دالة فتح مودال تغيير التاريخ
        function openChangeDateModal(index) {
            currentDateChangeIndex = index;
            const booking = bookings[index];
            
            // تعبئة معلومات الحجز
            document.getElementById('selectedBookingInfo').innerHTML = `
                <strong>الاسم:</strong> ${booking.الاسم}<br>
                <strong>الهاتف:</strong> ${booking.الهاتف}<br>
                <strong>التاريخ الحالي:</strong> ${formatDate(booking.التاريخ)}
            `;
            
            // تعيين التاريخ الحالي كقيمة افتراضية
            document.getElementById('newBookingDate').value = booking.التاريخ.split('T')[0];
            
            document.getElementById('changeDateModal').style.display = 'flex';
        }

        // دالة تغيير التاريخ
        function changeBookingDate(index, newDate) {
            const booking = bookings[index];
            const oldDate = booking.التاريخ;
            
            // تحديث التاريخ
            booking.التاريخ = newDate;
            
            // حفظ التغييرات
            saveBookings();
            
            showToast(`تم تغيير تاريخ الحجز من ${formatDate(oldDate)} إلى ${formatDate(newDate)}`);
        }

        // تحديث دالة عرض الجدول لإضافة عمود التاريخ وأزرار التحويل
        function renderBookingsTable() {
            const tbody = document.getElementById('bookingsTableBody');
            let monthBookings = getBookingsForMonth(currentMonth, currentYear);
            
            if (currentFilter !== 'all') {
                monthBookings = monthBookings.filter(booking => booking.الحالة === currentFilter);
            }
            
            if (monthBookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>لا توجد حجوزات لعرضها</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            monthBookings.forEach((booking, index) => {
                const statusClass = {
                    'تم الاشتراك': 'green',
                    'غير مشترك': 'red',
                    'غير موافق': 'yellow'
                }[booking.الحالة] || 'red';
                
                const originalIndex = bookings.indexOf(booking);
                
                html += `
                    <tr>
                        <td>${booking.الاسم}</td>
                        <td>
                            <a href="tel:${booking.الهاتف}" class="phone-link">
                                <i class="fas fa-phone"></i> ${booking.الهاتف}
                            </a>
                        </td>
                        <td>${booking.اسم_الوكيل || '-'}</td>
                        <td>${booking.اسم_المستخدم || '-'}</td>
                        <td>${booking.العرض}</td>
                        <td>
                            <span class="status-led ${statusClass}"></span>
                            ${booking.الحالة}
                        </td>
                        <td class="date-display">
                            ${formatTableDate(booking.التاريخ)}
                        </td>
                        <td>${booking.الإحداثيات || 'غير محدد'}</td>
                        <td class="table-actions">
                            <button class="table-btn edit" onclick="openEditModal(${originalIndex})" title="تعديل الحجز">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-btn change-date" onclick="openChangeDateModal(${originalIndex})" title="تغيير التاريخ">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                            <button class="table-btn map" onclick="openMap('${booking.الإحداثيات}')" title="فتح الخريطة" ${!booking.الإحداثيات || booking.الإحداثيات === 'غير محدد' ? 'disabled' : ''}>
                                <i class="fas fa-map"></i>
                            </button>
                            <button class="table-btn whatsapp" onclick="sendToWhatsApp(${originalIndex})" title="إرسال إلى واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="table-btn delete" onclick="deleteBooking(${originalIndex})" title="حذف الحجز">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // تحديث الجدول في HTML لإضافة عمود التاريخ
        // تغيير head الجدول ليشمل عمود التاريخ
        document.querySelector('#bookingsTable thead tr').innerHTML = `
            <th>الاسم</th>
            <th>الهاتف</th>
            <th>اسم الوكيل</th>
            <th>PPPoE</th>
            <th>العرض</th>
            <th>الحالة</th>
            <th>التاريخ</th>
            <th>الإحداثيات</th>
            <th>الإجراءات</th>
        `;

        // إضافة مستمعي الأحداث للتاريخ السريع
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const daysToAdd = parseInt(this.getAttribute('data-days'));
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + daysToAdd);
                
                // تنسيق التاريخ بشكل صحيح للـ input
                const formattedDate = newDate.toISOString().split('T')[0];
                document.getElementById('newBookingDate').value = formattedDate;
            });
        });

        // حفظ تغيير التاريخ
        document.getElementById('saveDateChangeBtn').addEventListener('click', function() {
            if (currentDateChangeIndex === -1) return;
            
            const newDate = document.getElementById('newBookingDate').value;
            if (!newDate) {
                showToast('يرجى اختيار تاريخ جديد', 'error');
                return;
            }
            
            // تحويل التاريخ إلى صيغة ISO
            const isoDate = new Date(newDate + 'T12:00:00').toISOString();
            
            changeBookingDate(currentDateChangeIndex, isoDate);
            document.getElementById('changeDateModal').style.display = 'none';
        });

        // إلغاء تغيير التاريخ
        document.getElementById('cancelDateChangeBtn').addEventListener('click', function() {
            document.getElementById('changeDateModal').style.display = 'none';
        });

        // إغلاق مودال تغيير التاريخ
        document.getElementById('changeDateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // تحديث دالة الحصول على حجوزات الشهر لاستخدام التاريخ الصحيح
        function getBookingsForMonth(month, year) {
            return bookings.filter(booking => {
                if (!booking.التاريخ) return false;
                const bookingDate = new Date(booking.التاريخ);
                return bookingDate.getMonth() === month && bookingDate.getFullYear() === year;
            });
        }

        // تحديث دالة حفظ الحجز لاستخدام التاريخ الحالي إذا لم يتم التحديد
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const selectedOffer = document.querySelector('input[name="offer"]:checked');
            
            if (!name || !phone || !selectedOffer) {
                showToast('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            const booking = {
                الاسم: name,
                الهاتف: phone,
                اسم_الوكيل: document.getElementById('agent').value.trim(),
                اسم_المستخدم: document.getElementById('pppoeUsername').value.trim(),
                العرض: selectedOffer.value,
                ملاحظات: document.getElementById('notes').value.trim(),
                الحالة: document.getElementById('status').value,
                الإحداثيات: latEl.value && lngEl.value ? `${latEl.value}, ${lngEl.value}` : "غير محدد",
                التاريخ: new Date().toISOString() // دائماً نستخدم التاريخ الحالي
            };
            
            bookings.push(booking);
            saveBookings();
            
            // باقي الكود...
        });

        // إضافة زر لتحويل الحجز إلى شهر آخر في الجدول
        function transferToNextMonth(index) {
            const booking = bookings[index];
            const currentDate = new Date(booking.التاريخ);
            
            // إضافة شهر واحد
            currentDate.setMonth(currentDate.getMonth() + 1);
            
            // تحديث التاريخ
            booking.التاريخ = currentDate.toISOString();
            
            saveBookings();
            showToast('تم تحويل الحجز إلى الشهر التالي');
        }

        function transferToPrevMonth(index) {
            const booking = bookings[index];
            const currentDate = new Date(booking.التاريخ);
            
            // طرح شهر واحد
            currentDate.setMonth(currentDate.getMonth() - 1);
            
            // تحديث التاريخ
            booking.التاريخ = currentDate.toISOString();
            
            saveBookings();
            showToast('تم تحويل الحجز إلى الشهر السابق');
        }

        // تحديث واجهة المستخدم لإضافة أزرار التحويل السريع
        // يمكن إضافتها في عمود الإجراءات أو كأزرار منفصلة
    </script>
</body>
</html>
