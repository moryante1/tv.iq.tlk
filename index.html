<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>team group nbtl</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #0ea5e9;
  --accent-hover: #0284c7;
  --muted: #6b7280;
  --text: #111827;
  --green: #10b981;
  --yellow: #f59e0b;
  --red: #ef4444;
  --blue: #3b82f6;
  color-scheme: light;
}
body {
  font-family: 'Segoe UI', Tahoma, Arial, Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 12px;
}
.container {
  max-width: 1200px;
  margin: 12px auto;
  padding: 16px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
h1 {
  margin: 0 0 16px;
  font-size: clamp(20px, 5vw, 22px);
  text-align: center;
  color: var(--accent);
}
form {
  display: grid;
  gap: 12px;
}
label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 4px;
  display: block;
}
input[type=text], input[type=tel], textarea, select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  color: var(--text);
  font-size: 14px;
  transition: border 0.2s, box-shadow 0.2s;
  box-sizing: border-box;
}
input[type=text]:focus, input[type=tel]:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(14,165,233,0.2);
}
.row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
#map {
  height: 250px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.offers {
  background: #f3f4f6;
  padding: 10px;
  border-radius: 8px;
}
.offers label {
  display: block;
  padding: 6px 0;
  cursor: pointer;
  font-size: 14px;
}
.btn {
  display: inline-block;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  text-align: center;
  width: 100%;
  max-width: 200px;
}
.btn:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
}
.muted {
  font-size: 12px;
  color: var(--muted);
}
img.logo {
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
#manualOffer {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  width: 100%;
  display: none;
  margin-top: 8px;
  box-sizing: border-box;
}
#offerDetails {
  margin-top: 8px;
  padding: 8px;
  background: #eef2f7;
  border-radius: 8px;
  font-size: 13px;
}
#offersModal, #editOfferModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#offersModal > div, #editOfferModal > div {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  max-width: 90%;
  width: 400px;
  max-height: 80vh;
  overflow-y: auto;
}
.stats-section {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-bottom: 16px;
}
.stats-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--accent);
  text-align: center;
}
.stats-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.stat-card {
  background: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  border-right: 3px solid var(--accent);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.stat-card.today {
  border-right-color: #10b981;
}
.stat-card.offers {
  border-right-color: #f59e0b;
}
.stat-value {
  font-size: 20px;
  font-weight: 700;
  margin: 4px 0;
  color: var(--text);
}
.stat-label {
  font-size: 12px;
  color: var(--muted);
}
.popular-offers {
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin-top: 8px;
}
.offer-stat {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #f1f5f9;
  font-size: 13px;
}
.offer-stat:last-child {
  border-bottom: none;
}
.offer-name {
  font-weight: 500;
}
.offer-count {
  color: var(--accent);
  font-weight: 600;
}
.bookings-section {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-top: 16px;
}
.bookings-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--accent);
  text-align: center;
}
#bookingsTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
#bookingsTable th, #bookingsTable td {
  border: 1px solid #e5e7eb;
  padding: 8px;
  text-align: right;
  font-size: 13px;
}
#bookingsTable th {
  background: #f1f5f9;
  font-weight: 600;
}
#bookingsTable tr:nth-child(even) {
  background: #f9fafb;
}
#bookingsTable .edit-btn, #bookingsTable .delete-btn {
  background: #f59e0b;
  padding: 6px 12px;
  border-radius: 4px;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 12px;
  width: auto;
}
#bookingsTable .delete-btn {
  background: #ef4444;
}
#bookingsTable .edit-btn:hover {
  background: #d97706;
}
#bookingsTable .delete-btn:hover {
  background: #dc2626;
}
.status-led {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-left: 8px;
  vertical-align: middle;
}
.status-led.green {
  background: var(--green);
}
.status-led.yellow {
  background: var(--yellow);
}
.status-led.red {
  background: var(--red);
}
.status-led.blue {
  background: var(--blue);
}
.offer-item {
  margin-bottom: 8px;
  padding: 8px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #f9fafb;
}
.offer-item input, .offer-item select {
  width: 100%;
  padding: 8px;
  margin-bottom: 4px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  box-sizing: border-box;
}
.removeOfferBtn {
  background: #f87171;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 4px;
  width: 100%;
}
.removeOfferBtn:hover {
  background: #ef4444;
}
@media (min-width: 768px) {
  .container {
    padding: 20px;
    margin: 20px auto;
  }
  h1 {
    font-size: 24px;
  }
  .row {
    grid-template-columns: 1fr 1fr;
  }
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .btn {
    max-width: 180px;
  }
  #map {
    height: 300px;
  }
  #bookingsTable th, #bookingsTable td {
    padding: 10px;
    font-size: 14px;
  }
}
@media (max-width: 767px) {
  body {
    padding: 8px;
  }
  .container {
    padding: 12px;
    margin: 8px;
    border-radius: 8px;
  }
  h1 {
    font-size: 18px;
  }
  form {
    gap: 10px;
  }
  label {
    font-size: 13px;
  }
  input[type=text], input[type=tel], textarea, select {
    padding: 8px;
    font-size: 13px;
  }
  .btn {
    padding: 8px 12px;
    font-size: 13px;
    max-width: 100%;
  }
  #map {
    height: 200px;
  }
  .stats-section, .bookings-section {
    padding: 10px;
  }
  .stats-title, .bookings-title {
    font-size: 15px;
  }
  .stat-card {
    padding: 8px;
  }
  .stat-value {
    font-size: 18px;
  }
  .stat-label {
    font-size: 11px;
  }
  .offer-stat {
    font-size: 12px;
  }
  #offersModal > div, #editOfferModal > div {
    width: 95%;
    padding: 12px;
  }
  #bookingsTable {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
}
</style>
</head>
<body>
<div class="container">
  <div style="text-align:center; margin-bottom:12px;">
    <img src="https://reseller.nbtel.iq/nb_logo.png" alt="Ø´Ø¹Ø§Ø± NBTEL" class="logo" style="width:100px; height:auto;">
  </div>
  <h1>Ø­Ø¬ÙˆØ²Ø§Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” ØªÙ„ÙƒÙŠÙ</h1>
  <div class="stats-section">
    <div class="stats-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <div class="stat-value" id="totalBookings">0</div>
      </div>
      <div class="stat-card today">
        <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="stat-value" id="todayBookings">0</div>
      </div>
      <div class="stat-card offers">
        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
        <div class="stat-value" id="totalOffers">0</div>
      </div>
    </div>
    <div class="popular-offers">
      <div style="font-weight:600; margin-bottom:8px; color:var(--muted); font-size:13px;">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹:</div>
      <div id="popularOffers">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</div>
    </div>
  </div>
  <form id="bookingForm" autocomplete="on" novalidate>
    <div class="row">
      <div>
        <label for="name">Ø§Ù„Ø§Ø³Ù…</label>
        <input id="name" name="name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ" required>
      </div>
      <div>
        <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="phone" name="phone" type="tel" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
      </div>
    </div>
    <div>
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶</label>
      <div class="offers" id="offersContainer"></div>
      <input type="text" id="manualOffer" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§..." style="display:none;">
      <div id="offerDetails">Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.</div>
      <button type="button" class="btn" style="background:#6366f1;margin-top:8px" id="manageOffersBtn">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
    </div>
    <div>
      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
      <textarea id="notes" name="notes" rows="3" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…ÙØµÙ„ØŒ Ø·Ø§Ø¨Ù‚ØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„ÙˆØµÙˆÙ„..."></textarea>
    </div>
    <div>
      <label for="status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
      <select id="status" name="status">
        <option value="ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</option>
        <option value="ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚">ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚</option>
        <option value="ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ">ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ</option>
        <option value="ØªÙ… Ø±ÙØ¶ Ù†Ù‡Ø§Ø¦ÙŠ">ØªÙ… Ø±ÙØ¶ Ù†Ù‡Ø§Ø¦ÙŠ</option>
      </select>
    </div>
    <div>
      <label>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
      <div id="map"></div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
        <button type="button" id="locateBtn" class="btn">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button type="button" id="pickBtn" class="btn">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø©</button>
        <button type="button" id="clearBtn" class="btn" style="background:#f87171">Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
      </div>
      <div class="muted" style="margin-top:8px">Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø®ØªØ§Ø±Ø©: <span id="coords">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</span></div>
    </div>
    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lng" name="lng">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;margin-top:8px;justify-content:end;">
      <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ±Ø¯ÙŠ</button>
      <button type="button" id="exportBtn" class="btn" style="background:#38bdf8">ØªØµØ¯ÙŠØ± Excel</button>
      <button type="button" id="backupBtn" class="btn" style="background:#16a34a">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ©</button>
      <input type="file" id="importJSON" style="display:none">
      <button type="button" class="btn" style="background:#f59e0b" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <button type="button" class="btn" style="background:#f87171" id="clearAllBtn">Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
      <button type="button" class="btn" style="background:#ef4444" id="clearTodayBtn">Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
      <button type="button" class="btn" style="background:#6b7280" id="toggleTableBtn">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>
  </form>
  <div class="bookings-section" id="bookingsSection">
    <div class="bookings-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div style="margin-bottom:12px;">
      <label for="searchByName">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø¬Ø² Ø¨Ø§Ù„Ø§Ø³Ù…</label>
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
        <input type="text" id="searchByName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
        <button type="button" class="btn" style="background:#6366f1" id="searchByNameBtn">Ø¨Ø­Ø«</button>
      </div>
    </div>
    <table id="bookingsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ø¹Ø±Ø¶</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="bookingsTableBody"></tbody>
    </table>
  </div>
</div>
<div id="offersModal">
  <div>
    <h2 style="margin-top:0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h2>
    <div id="offersList"></div>
    <button type="button" class="btn" id="addOfferBtn" style="background:#10b981;margin-top:8px">Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</button>
    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
      <button type="button" class="btn" id="saveOffersBtn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      <button type="button" class="btn" style="background:#f87171" id="closeOffersBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
<div id="editOfferModal">
  <div>
    <h2 style="margin-top:0">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h2>
    <div class="offers" id="editOffersContainer"></div>
    <input type="text" id="editManualOffer" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹..." style="display:none;">
    <div>
      <label for="editNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
      <textarea id="editNotes" name="editNotes" rows="3" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…ÙØµÙ„ØŒ Ø·Ø§Ø¨Ù‚ØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„ÙˆØµÙˆÙ„..."></textarea>
    </div>
    <div>
      <label for="editStatus">Ø§Ù„Ø­Ø§Ù„Ø©</label>
      <select id="editStatus" name="editStatus">
        <option value="ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</option>
        <option value="ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚">ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚</option>
        <option value="ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ">ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ</option>
        <option value="ØªÙ… Ø±ÙØ¶ Ù†Ù‡Ø§Ø¦ÙŠ">ØªÙ… Ø±ÙØ¶ Ù†Ù‡Ø§Ø¦ÙŠ</option>
      </select>
    </div>
    <div>
      <label>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <input type="text" id="editLat" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶" />
        <input type="text" id="editLng" placeholder="Ø®Ø· Ø§Ù„Ø·ÙˆÙ„" />
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
        <button type="button" class="btn" id="editLocateBtn">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button type="button" class="btn" id="editPickBtn">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø©</button>
        <button type="button" class="btn" style="background:#f87171" id="editClearBtn">Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
      </div>
      <div id="editMap" style="height:200px;margin-top:8px;border-radius:8px;border:1px solid #e5e7eb;"></div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px;">
      <button type="button" class="btn" id="saveEditOfferBtn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      <button type="button" class="btn" style="background:#f87171" id="closeEditOfferBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======= Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =======
let bookings = JSON.parse(localStorage.getItem('bookings')) || [];
let offerInfo = JSON.parse(localStorage.getItem('offerInfo')) || {
    "Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„ÙŠØ§Ù Ø§Ù„Ø¨ØµØ±ÙŠØ©": {description: "Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù†ØªØ±Ù†Øª Ø¨Ø³Ø±Ø¹Ø© 100 Ù…ÙŠØºØ§Ø¨Øª/Ø« Ù…Ø¹ ØªØ±ÙƒÙŠØ¨ Ù…Ø¬Ø§Ù†ÙŠ", price: "100,000 Ø¯.Ø¹"},
    "Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©": {description: "Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© 6 Ø£Ø´Ù‡Ø± Ø¨Ø³Ø±Ø¹Ø© 50 Ù…ÙŠØºØ§Ø¨Øª/Ø«", price: "60,000 Ø¯.Ø¹"},
    "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨": {description: "Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù†ØªØ±Ù†Øª Ø¨Ø³Ø±Ø¹Ø© 25 Ù…ÙŠØºØ§Ø¨Øª/Ø« Ù„Ù„Ø·Ù„Ø§Ø¨", price: "40,000 Ø¯.Ø¹"}
};
function updateStats() {
    try {
        console.log('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =', bookings.length);
        document.getElementById('totalBookings').textContent = bookings.length;
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(booking => {
            if (!booking.Ø§Ù„ØªØ§Ø±ÙŠØ®) return false;
            const bookingDate = new Date(booking.Ø§Ù„ØªØ§Ø±ÙŠØ®).toISOString().split('T')[0];
            return bookingDate === today;
        }).length;
        document.getElementById('todayBookings').textContent = todayBookings;
        const uniqueOffers = new Set(bookings.map(booking => booking.Ø§Ù„Ø¹Ø±Ø¶).filter(offer => offer));
        const totalOffers = Object.keys(offerInfo).length + (uniqueOffers.size - Object.keys(offerInfo).filter(offer => uniqueOffers.has(offer)).length);
        document.getElementById('totalOffers').textContent = totalOffers;
        updatePopularOffers();
        renderBookingsTable();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    }
}
function updatePopularOffers() {
    try {
        if (bookings.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯</div>';
            return;
        }
        const offerCounts = {};
        bookings.forEach(booking => {
            const offer = booking.Ø§Ù„Ø¹Ø±Ø¶ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            offerCounts[offer] = (offerCounts[offer] || 0) + 1;
        });
        const sortedOffers = Object.entries(offerCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        if (sortedOffers.length === 0) {
            document.getElementById('popularOffers').innerHTML = '<div style="color:var(--muted); font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</div>';
            return;
        }
        let html = '';
        sortedOffers.forEach(([offer, count]) => {
            html += `<div class="offer-stat"><span class="offer-name">${offer}</span><span class="offer-count">${count} Ø­Ø¬Ø²</span></div>`;
        });
        document.getElementById('popularOffers').innerHTML = html;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:', error);
    }
}

// ======= Ø§Ù„Ø¬Ø¯ÙˆÙ„ =======
let currentSearchQuery = '';
function renderBookingsTable(searchQuery = '') {
    try {
        console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =', bookings.length, 'Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¨Ø­Ø«:', searchQuery);
        const tbody = document.getElementById('bookingsTableBody');
        if (!tbody) {
            console.error('Ø¹Ù†ØµØ± bookingsTableBody ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        let html = '';
        const filteredBookings = searchQuery ? 
            bookings.filter(booking => booking.Ø§Ù„Ø§Ø³Ù….toLowerCase().includes(searchQuery.toLowerCase())) : 
            bookings;
        if (filteredBookings.length === 0) {
            html = `<tr><td colspan="8" style="text-align:center;color:var(--muted);">
                ${searchQuery ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù€ "' + searchQuery + '"' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª'}
                </td></tr>`;
        } else {
            filteredBookings.forEach((booking, index) => {
                if (!booking || !booking.Ø§Ù„Ø§Ø³Ù… || !booking.Ø§Ù„Ù‡Ø§ØªÙ || !booking.Ø§Ù„Ø¹Ø±Ø¶) {
                    console.warn('Ø­Ø¬Ø² ØºÙŠØ± ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³:', index, booking);
                    return;
                }
                const originalIndex = bookings.indexOf(booking);
                const statusClass = {
                    'ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': 'green',
                    'ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚': 'yellow',
                    'ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ': 'red',
                    'ØªÙ… Ø±ÙØ¶ Ù†Ù‡Ø§Ø¦ÙŠ': 'blue'
                }[booking.Ø§Ù„Ø­Ø§Ù„Ø©] || 'red';
                html += `
                    <tr>
                        <td>${booking.Ø§Ù„Ø§Ø³Ù… || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${booking.Ø§Ù„Ù‡Ø§ØªÙ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${booking.Ø§Ù„Ø¹Ø±Ø¶ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${booking.Ù…Ù„Ø§Ø­Ø¸Ø§Øª || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</td>
                        <td><span class="status-led ${statusClass}"></span> ${booking.Ø§Ù„Ø­Ø§Ù„Ø© || 'ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ'}</td>
                        <td>${booking.Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td><button class="edit-btn" data-index="${originalIndex}">ØªØ¹Ø¯ÙŠÙ„</button></td>
                        <td><button class="delete-btn" data-index="${originalIndex}">Ø­Ø°Ù</button></td>
                    </tr>`;
            });
        }
        tbody.innerHTML = html;
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = btn.getAttribute('data-index');
                openEditOfferModal(index);
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = btn.getAttribute('data-index');
                const booking = bookings[index];
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø¬Ø² ${booking.Ø§Ù„Ø§Ø³Ù…}ØŸ`)) {
                    bookings.splice(index, 1);
                    saveBookings();
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!');
                    renderBookingsTable(currentSearchQuery);
                }
            });
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
}

// ======= Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =======
document.getElementById('searchByNameBtn').addEventListener('click', () => {
    try {
        const searchQuery = document.getElementById('searchByName').value.trim();
        currentSearchQuery = searchQuery;
        renderBookingsTable(searchQuery);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.');
    }
});
document.getElementById('searchByName').addEventListener('input', () => {
    try {
        const searchQuery = document.getElementById('searchByName').value.trim();
        currentSearchQuery = searchQuery;
        renderBookingsTable(searchQuery);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø­Ø«:', error);
    }
});

// ======= Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =======
const toggleTableBtn = document.getElementById('toggleTableBtn');
const bookingsSection = document.getElementById('bookingsSection');
toggleTableBtn.addEventListener('click', () => {
    try {
        if (bookingsSection.style.display === 'none') {
            bookingsSection.style.display = 'block';
            toggleTableBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
            renderBookingsTable(currentSearchQuery);
        } else {
            bookingsSection.style.display = 'none';
            toggleTableBtn.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
    }
});

// ======= Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ… =======
document.getElementById('clearTodayBtn').addEventListener('click', () => {
    try {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ')) {
            const today = new Date().toISOString().split('T')[0];
            bookings = bookings.filter(booking => {
                if (!booking.Ø§Ù„ØªØ§Ø±ÙŠØ®) return true;
                const bookingDate = new Date(booking.Ø§Ù„ØªØ§Ø±ÙŠØ®).toISOString().split('T')[0];
                return bookingDate !== today;
            });
            localStorage.setItem('bookings', JSON.stringify(bookings));
            updateStats();
            renderBookingsTable(currentSearchQuery);
            alert('ØªÙ… Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ….');
    }
});

// ======= ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² =======
let currentEditIndex = null;
let editMap, editMarker;
function openEditOfferModal(index) {
    try {
        currentEditIndex = index;
        const editOffersContainer = document.getElementById('editOffersContainer');
        editOffersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'editOffer';
            radio.value = key;
            radio.id = 'edit-offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            editOffersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'editOffer';
        manualRadio.value = 'manual';
        manualRadio.id = 'edit-offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'edit-offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹'));
        editOffersContainer.appendChild(manualLabel);
        const editManualOfferInput = document.getElementById('editManualOffer');
        const editNotesInput = document.getElementById('editNotes');
        const editStatusSelect = document.getElementById('editStatus');
        const editLatInput = document.getElementById('editLat');
        const editLngInput = document.getElementById('editLng');
        editManualOfferInput.style.display = 'none';
        editManualOfferInput.value = '';
        editNotesInput.value = bookings[index].Ù…Ù„Ø§Ø­Ø¸Ø§Øª || '';
        editStatusSelect.value = bookings[index].Ø§Ù„Ø­Ø§Ù„Ø© || 'ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ';
        const currentOffer = bookings[index].Ø§Ù„Ø¹Ø±Ø¶ || '';
        const isManual = !offerInfo[currentOffer];
        if (isManual) {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
            editManualOfferInput.value = currentOffer;
        } else if (hasOffers) {
            const offerRadio = document.querySelector(`input[name="editOffer"][value="${currentOffer}"]`);
            if (offerRadio) offerRadio.checked = true;
            else document.getElementById('edit-offer-manual').checked = true;
        } else {
            document.getElementById('edit-offer-manual').checked = true;
            editManualOfferInput.style.display = 'block';
        }
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        const coords = bookings[index].Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª?.split(',') || [];
        editLatInput.value = coords[0]?.trim() || '';
        editLngInput.value = coords[1]?.trim() || '';
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        if (!editMap) {
            editMap = L.map('editMap', { zoomControl: true }).setView([36.3719, 43.1228], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(editMap);
        } else {
            editMap.setView([36.3719, 43.1228], 12);
        }
        if (editMarker) {
            editMap.removeLayer(editMarker);
            editMarker = null;
        }
        if (editLatInput.value && editLngInput.value) {
            const lat = parseFloat(editLatInput.value);
            const lng = parseFloat(editLngInput.value);
            if (!isNaN(lat) && !isNaN(lng)) {
                editMarker = L.marker([lat, lng]).addTo(editMap);
                editMap.flyTo([lat, lng], 16);
            }
        }
        document.getElementById('editOfferModal').style.display = 'flex';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
    }
}
document.getElementById('saveEditOfferBtn').addEventListener('click', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (!selectedRadio) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? document.getElementById('editManualOffer').value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedOffer].price : selectedOffer);
        const lat = document.getElementById('editLat').value.trim();
        const lng = document.getElementById('editLng').value.trim();
        const coords = lat && lng ? `${lat}, ${lng}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        bookings[currentEditIndex].Ø§Ù„Ø¹Ø±Ø¶ = offerText;
        bookings[currentEditIndex].Ø§Ù„ØªÙØ§ØµÙŠÙ„ = offerDesc;
        bookings[currentEditIndex].Ù…Ù„Ø§Ø­Ø¸Ø§Øª = document.getElementById('editNotes').value.trim();
        bookings[currentEditIndex].Ø§Ù„Ø­Ø§Ù„Ø© = document.getElementById('editStatus').value;
        bookings[currentEditIndex].Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª = coords;
        saveBookings();
        document.getElementById('editOfferModal').style.display = 'none';
        alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!');
        renderBookingsTable(currentSearchQuery);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
    }
});
document.getElementById('closeEditOfferBtn').addEventListener('click', () => {
    try {
        document.getElementById('editOfferModal').style.display = 'none';
        if (editMarker) {
            editMap.removeLayer(editMarker);
            editMarker = null;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²:', error);
    }
});
document.getElementById('editOffersContainer').addEventListener('change', () => {
    try {
        const selectedRadio = document.querySelector('input[name="editOffer"]:checked');
        if (selectedRadio && selectedRadio.value === 'manual') {
            document.getElementById('editManualOffer').style.display = 'block';
        } else {
            document.getElementById('editManualOffer').style.display = 'none';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²:', error);
    }
});
document.getElementById('editManualOffer').addEventListener('input', () => {
    try {
        if (document.getElementById('edit-offer-manual').checked) {
            document.getElementById('editManualOffer').value;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
    }
});
document.getElementById('editLocateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            document.getElementById('editLat').value = lat.toFixed(6);
            document.getElementById('editLng').value = lng.toFixed(6);
            if (editMarker) editMap.removeLayer(editMarker);
            editMarker = L.marker([lat, lng]).addTo(editMap);
            editMap.flyTo([lat, lng], 16);
        },
        err => {
            let message;
            switch (err.code) {
                case err.PERMISSION_DENIED: message = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'; break;
                case err.POSITION_UNAVAILABLE: message = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.'; break;
                case err.TIMEOUT: message = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'; break;
                default: message = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ' + err.message;
            }
            alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
});
document.getElementById('editPickBtn').addEventListener('click', () => {
    alert('Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
    const onClick = (e) => {
        document.getElementById('editLat').value = e.latlng.lat.toFixed(6);
        document.getElementById('editLng').value = e.latlng.lng.toFixed(6);
        if (editMarker) editMap.removeLayer(editMarker);
        editMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(editMap);
        editMap.flyTo([e.latlng.lat, e.latlng.lng], 16);
        editMap.off('click', onClick);
    };
    editMap.on('click', onClick);
});
document.getElementById('editClearBtn').addEventListener('click', () => {
    document.getElementById('editLat').value = '';
    document.getElementById('editLng').value = '';
    if (editMarker) {
        editMap.removeLayer(editMarker);
        editMarker = null;
    }
});

// ======= Ø§Ù„Ø®Ø±ÙŠØ·Ø© =======
const map = L.map('map', {zoomControl: true}).setView([36.3719, 43.1228], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Â© OpenStreetMap contributors'}).addTo(map);
let marker = null;
const coordsEl = document.getElementById('coords');
const latEl = document.getElementById('lat');
const lngEl = document.getElementById('lng');
function setCoords(lat, lng) {
    try {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.flyTo([lat, lng], 16);
        coordsEl.textContent = lat.toFixed(6) + ' , ' + lng.toFixed(6);
        latEl.value = lat;
        lngEl.value = lng;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:', error);
    }
}
document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) { alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); return; }
    navigator.geolocation.getCurrentPosition(
        pos => { setCoords(pos.coords.latitude, pos.coords.longitude); },
        err => {
            let message;
            switch (err.code) {
                case err.PERMISSION_DENIED: message = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.'; break;
                case err.POSITION_UNAVAILABLE: message = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.'; break;
                case err.TIMEOUT: message = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'; break;
                default: message = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ' + err.message;
            }
            alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
});
document.getElementById('pickBtn').addEventListener('click', () => {
    alert('Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
    const onClick = (e) => { setCoords(e.latlng.lat, e.latlng.lng); map.off('click', onClick); };
    map.on('click', onClick);
});
document.getElementById('clearBtn').addEventListener('click', () => {
    try {
        if (marker) map.removeLayer(marker);
        marker = null;
        coordsEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
        latEl.value = '';
        lngEl.value = '';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:', error);
    }
});

// ======= Ø§Ù„Ø¹Ø±ÙˆØ¶ =======
const offersContainer = document.getElementById('offersContainer');
const offerDetails = document.getElementById('offerDetails');
const manualOfferInput = document.getElementById('manualOffer');
function renderOffers() {
    try {
        offersContainer.innerHTML = '';
        let hasOffers = false;
        for (let key in offerInfo) {
            hasOffers = true;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'offer';
            radio.value = key;
            radio.id = 'offer-' + key.replace(/\s+/g, '-');
            const label = document.createElement('label');
            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(' ' + key));
            offersContainer.appendChild(label);
        }
        const manualRadio = document.createElement('input');
        manualRadio.type = 'radio';
        manualRadio.name = 'offer';
        manualRadio.value = 'manual';
        manualRadio.id = 'offer-manual';
        const manualLabel = document.createElement('label');
        manualLabel.htmlFor = 'offer-manual';
        manualLabel.appendChild(manualRadio);
        manualLabel.appendChild(document.createTextNode(' ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹'));
        offersContainer.appendChild(manualLabel);
        const firstRadio = hasOffers ? document.querySelector('input[name="offer"]') : document.getElementById('offer-manual');
        if (firstRadio) firstRadio.checked = true;
        updateOfferDetails();
        updateStats();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
    }
}
function updateOfferDetails() {
    try {
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            offerDetails.textContent = 'Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.';
            manualOfferInput.style.display = 'none';
            return;
        }
        const selectedValue = selectedRadio.value;
        if (selectedValue === 'manual') {
            manualOfferInput.style.display = 'block';
            offerDetails.textContent = manualOfferInput.value || 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§.';
        } else {
            manualOfferInput.style.display = 'none';
            offerDetails.textContent = offerInfo[selectedValue] ? 
                offerInfo[selectedValue].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedValue].price : 
                'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶:', error);
    }
}
renderOffers();
offersContainer.addEventListener('change', updateOfferDetails);
manualOfferInput.addEventListener('input', () => {
    try {
        if (document.getElementById('offer-manual').checked) {
            offerDetails.textContent = manualOfferInput.value || 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§.';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
    }
});

// ======= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…ÙˆØ¯Ø§Ù„) =======
const manageOffersBtn = document.getElementById('manageOffersBtn');
const offersModal = document.getElementById('offersModal');
const offersList = document.getElementById('offersList');
const addOfferBtn = document.getElementById('addOfferBtn');
const saveOffersBtn = document.getElementById('saveOffersBtn');
const closeOffersBtn = document.getElementById('closeOffersBtn');
function renderOffersModal() {
    try {
        offersList.innerHTML = '';
        for (let key in offerInfo) {
            const div = document.createElement('div');
            div.className = 'offer-item';
            div.innerHTML = `
                <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" value="${key}" class="offerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶"></div>
                <div><label>ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" value="${offerInfo[key].description}" class="offerDesc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶"></div>
                <div><label>Ø§Ù„Ø³Ø¹Ø±:</label><input type="text" value="${offerInfo[key].price}" class="offerPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±"></div>
                <button type="button" class="removeOfferBtn">Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
            `;
            offersList.appendChild(div);
            div.querySelector('.removeOfferBtn').addEventListener('click', function() {
                if (Object.keys(offerInfo).length <= 1) {
                    alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                    return;
                }
                div.remove();
            });
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
}
addOfferBtn.addEventListener('click', function() {
    try {
        const div = document.createElement('div');
        div.className = 'offer-item';
        div.innerHTML = `
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" class="offerName"></div>
            <div><label>ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶:</label><input type="text" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶" class="offerDesc"></div>
            <div><label>Ø§Ù„Ø³Ø¹Ø±:</label><input type="text" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="offerPrice"></div>
            <button type="button" class="removeOfferBtn">Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
        `;
        offersList.appendChild(div);
        div.querySelector('.removeOfferBtn').addEventListener('click', function() {
            if (offersList.children.length <= 1) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                return;
            }
            div.remove();
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯:', error);
    }
});
manageOffersBtn.addEventListener('click', function() {
    try {
        renderOffersModal();
        offersModal.style.display = 'flex';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
});
closeOffersBtn.addEventListener('click', function() {
    try {
        offersModal.style.display = 'none';
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
    }
});
saveOffersBtn.addEventListener('click', function() {
    try {
        const newOffers = {};
        let hasError = false;
        const names = new Set();
        offersList.querySelectorAll('.offer-item').forEach(div => {
            const name = div.querySelector('.offerName').value.trim();
            const desc = div.querySelector('.offerDesc').value.trim();
            const price = div.querySelector('.offerPrice').value.trim();
            if (name && desc && price) {
                if (names.has(name)) {
                    hasError = true;
                    alert(`Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ "${name}" Ù…ÙƒØ±Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.`);
                    return;
                }
                names.add(name);
                newOffers[name] = {description: desc, price: price};
            } else if (name || desc || price) {
                hasError = true;
            }
        });
        if (hasError) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ÙƒÙ„ Ø¹Ø±Ø¶ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©.');
            return;
        }
        if (Object.keys(newOffers).length === 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }
        offerInfo = newOffers;
        localStorage.setItem('offerInfo', JSON.stringify(offerInfo));
        renderOffers();
        offersModal.style.display = 'none';
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
});

// ======= Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =======
function saveBookings() {
    try {
        console.log('Ø­ÙØ¸ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', bookings);
        localStorage.setItem('bookings', JSON.stringify(bookings));
        bookings = JSON.parse(localStorage.getItem('bookings')) || [];
        console.log('Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸:', bookings);
        updateStats();
        renderBookingsTable(currentSearchQuery);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
}
updateStats();
const form = document.getElementById('bookingForm');
const phoneInput = document.getElementById('phone');
form.addEventListener('submit', function(e) {
    e.preventDefault();
    try {
        const name = form.name.value.trim();
        if (!name) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù….');
            return;
        }
        let phone = phoneInput.value.trim().replace(/[\s+()-]/g, '');
        if (!phone) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ.');
            return;
        }
        const selectedRadio = document.querySelector('input[name="offer"]:checked');
        if (!selectedRadio) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const selectedOffer = selectedRadio.value;
        let offerText = selectedOffer === 'manual' ? manualOfferInput.value.trim() : selectedOffer;
        if (selectedOffer === 'manual' && !offerText) {
            alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
            return;
        }
        const offerDesc = selectedOffer === 'manual' ? offerText :
            (offerInfo[selectedOffer] ? offerInfo[selectedOffer].description + ' â€” Ø§Ù„Ø³Ø¹Ø±: ' + offerInfo[selectedOffer].price : selectedOffer);
        const data = {
            Ø§Ù„Ø§Ø³Ù…: name,
            Ø§Ù„Ù‡Ø§ØªÙ: phone,
            Ø§Ù„Ø¹Ø±Ø¶: offerText,
            Ø§Ù„ØªÙØ§ØµÙŠÙ„: offerDesc,
            Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: latEl.value && lngEl.value ? `${latEl.value}, ${lngEl.value}` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            Ù…Ù„Ø§Ø­Ø¸Ø§Øª: form.notes.value.trim(),
            Ø§Ù„Ø­Ø§Ù„Ø©: form.status.value,
            Ø§Ù„ØªØ§Ø±ÙŠØ®: new Date().toISOString()
        };
        console.log('Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯:', data);
        bookings.push(data);
        saveBookings();
        const phoneNumber = "9647512328848";
        const message = encodeURIComponent(`ğŸ“¢ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯:
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${data.Ø§Ù„Ø§Ø³Ù…}
ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${data.Ø§Ù„Ù‡Ø§ØªÙ}
ğŸ“¦ Ø§Ù„Ø¹Ø±Ø¶: ${data.Ø§Ù„Ø¹Ø±Ø¶}
ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${data.Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª}
ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.Ù…Ù„Ø§Ø­Ø¸Ø§Øª.substring(0, 500)}
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(data.Ø§Ù„ØªØ§Ø±ÙŠØ®).toLocaleString('ar-IQ')}
ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: ${data.Ø§Ù„Ø­Ø§Ù„Ø©}`);
        window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨!");
        form.reset();
        if (marker) {
            map.removeLayer(marker);
            marker = null;
            coordsEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
            latEl.value = '';
            lngEl.value = '';
        }
        renderOffers();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø²:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„Ù‡. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
});

// ======= ØªØµØ¯ÙŠØ± Excel =======
function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}
document.getElementById('exportBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø­Ø¬ÙˆØ²Ø§Øª");
        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
        const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Ø­Ø¬ÙˆØ²Ø§Øª_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
});

// ======= Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ© =======
document.getElementById('backupBtn').addEventListener('click', () => {
    try {
        if (bookings.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!");
            return;
        }
        const date = new Date().toISOString().split('T')[0];
        const ws = XLSX.utils.json_to_sheet(bookings);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø­Ø¬ÙˆØ²Ø§Øª");
        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
        const xlsxBlob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
        const xlsxUrl = URL.createObjectURL(xlsxBlob);
        const xlsxA = document.createElement("a");
        xlsxA.href = xlsxUrl;
        xlsxA.download = `backup_${date}.xlsx`;
        document.body.appendChild(xlsxA);
        xlsxA.click();
        document.body.removeChild(xlsxA);
        URL.revokeObjectURL(xlsxUrl);
        const jsonBlob = new Blob([JSON.stringify(bookings, null, 2)], {type: "application/json"});
        const jsonUrl = URL.createObjectURL(jsonBlob);
        const jsonA = document.createElement('a');
        jsonA.href = jsonUrl;
        jsonA.download = `backup_${date}.json`;
        document.body.appendChild(jsonA);
        jsonA.click();
        document.body.removeChild(jsonA);
        URL.revokeObjectURL(jsonUrl);
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
    }
});

// ======= Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON =======
const importInput = document.getElementById('importJSON');
document.getElementById('importBtn').addEventListener('click', () => {
    importInput.click();
});
importInput.addEventListener('change', function(e) {
    try {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const imported = JSON.parse(evt.target.result);
                if (Array.isArray(imported)) {
                    const validBookings = imported.filter(booking => 
                        booking && booking.Ø§Ù„Ø§Ø³Ù… && booking.Ø§Ù„Ù‡Ø§ØªÙ && booking.Ø§Ù„Ø¹Ø±Ø¶
                    );
                    bookings = validBookings;
                    saveBookings();
                    alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ø¨Ù†Ø¬Ø§Ø­!");
                } else {
                    alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
                }
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON:', err);
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
            }
        };
        reader.readAsText(file);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù.');
    }
});

// ======= Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =======
document.getElementById('clearAllBtn').addEventListener('click', () => {
    try {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø­Ùˆ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§ØªØŸ")) {
            bookings = [];
            saveBookings();
            alert("ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª");
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ùˆ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ùˆ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.');
    }
});

// ======= Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Excel (ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠÙ‹Ø§) =======
var gk_isXlsx = false;
var gk_xlsxFileLookup = {};
var gk_fileData = {};
function filledCell(cell) {
    return cell !== '' && cell != null;
}
function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            var filteredData = jsonData.filter(row => row.some(filledCell));
            var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
            }
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
}
</script>
</body>
</html>
